#!/usr/bin/env bash
set -euo pipefail

# Git will run hooks from repository root when core.hooksPath is set.
# Block committing any .DS_Store files (macOS Finder metadata)
# If any .DS_Store files are staged, unstage them and fail the commit with guidance.
has_staged_dsstore=false
staged_dsstore_paths=$(git diff --cached --name-only --diff-filter=AM -z | tr '\0' '\n' | grep -E -i '\.DS_Store$' || true)
if [ -n "$staged_dsstore_paths" ]; then
  has_staged_dsstore=true
  echo "[pre-commit] 检测到已暂存的 .DS_Store 文件，已从暂存区移除。"
  echo "$staged_dsstore_paths" | while IFS= read -r f; do
    [ -n "$f" ] || continue
    git rm --cached --ignore-unmatch -- "$f" || true
  done
  echo "[pre-commit] 已阻止提交 .DS_Store。建议：
  1) 已在项目根添加 .gitignore 忽略 .DS_Store
  2) 如需清理本地，可运行：find . -name '.DS_Store' -type f -delete
  3) 重新执行 git commit"
  exit 1
fi

# Invoke the compression script; any failure will block the commit with a helpful message.
repo_root=$(git rev-parse --show-toplevel)
"${repo_root}/scripts/compress-staged-images.sh"