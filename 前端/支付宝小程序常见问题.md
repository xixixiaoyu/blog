### 1. 架构与运行时：理解双线程模型的“灵魂”

支付宝小程序采用**双线程模型**。

- **视图层：** 负责渲染界面，运行在一个独立的 WebView 环境中。
- **逻辑层：** 负责运行业务代码（JavaScript），运行在独立的 JSCore（iOS）或 V8（Android）环境中。

这两层之间通过原生客户端进行**异步通信**。你写的 JS 代码无法直接访问 DOM API，而是通过调用 `setData` 方法，将数据从逻辑层“序列化”后，经由原生客户端传递给视图层，视图层再进行“反序列化”并渲染。

所以要**敬畏 `setData`**：每一次 `setData` 都会触发一次完整的通信和渲染流程。因此，要避免频繁、大数据量的 `setData`。

合并多次 `setData` 为一次；只传递变化的数据字段，而不是整个对象；使用路径更新深层对象，如 `this.setData({'some.deep.path': value})`。

我们的核心任务是管理好 `data` 中的状态，让视图层自动响应这些变化。



### 2. API 与权限：平台能力的“正确打开方式”

支付宝小程序提供了丰富的原生能力，但使用它们必须遵循其规则。

支付的核心逻辑（如生成订单、签名）**必须**在你的服务端完成。前端（小程序）的角色是发起支付请求并展示支付结果。绝不能在前端处理敏感信息（如私钥、密钥），这是平台的红线，也是为了保障用户资金安全。

出于隐私保护，支付宝对用户信息的获取有严格的授权流程。你不能“静默”获取用户信息。必须通过 `my.getAuthCode` 获取授权码，再由该授权码换取用户信息或用于后续业务。这个过程需要用户主动点击和确认。

比如支付严格遵循“前端请求 -> 后端生成支付参数 -> 前端调用 `my.tradePay` -> 后端接收支付结果通知”的闭环。

在需要用户授权时，提供清晰的引导文案，告知用户为何需要此项授权，而不是在应用一启动就粗暴地弹出授权框。这会大大提高授权成功率。



### 3. UI 与样式：像素与组件的“适配之道”

小程序的样式系统既有 Web 的影子，也有自己的独特之处。

`rpx`（responsive pixel）是小程序的尺寸单位，规定屏幕宽度为 `750rpx`。它能帮你快速实现适配。但要注意，它在某些极端屏幕比例或需要精细控制（如 1px 边框）的场景下可能不完美。

**灵活使用 `rpx` 和 `px`**：布局、宽高、内外边距等使用 `rpx` 实现自适应。对于字体大小，有时使用 `px` 能更好地控制设计稿的还原度。对于需要极细的边框，可以考虑使用 CSS 的 `transform: scaleY(0.5)` 技巧。

为了防止样式污染，自定义组件默认是样式隔离的。你在页面中写的样式，默认不会影响到组件内部，反之亦然。

在自定义组件的 `Component` 构造器中，可以通过 `options.styleIsolation` 来配置样式隔离策略（`'isolated'`, `'apply-shared'`, `'shared'`）。当你需要在外部覆盖组件默认样式时，请务必了解并正确设置它。



### 4. 性能与体验：决定用户去留的“关键细节”

性能是小程序的生命线，尤其是在支付宝这种高频应用场景中。

小程序启动需要下载代码包、初始化双线程环境。代码包体积是影响启动速度的首要因素。

除了前面提到的 `setData` 问题，长列表渲染、频繁的动画等也是性能杀手。

我们可以：

1. **代码包分包加载**：这是优化启动性能的“大杀器”。将非核心、非首屏的页面和组件放到分包中，实现按需加载，极大减小主包体积。
2. **长列表优化**：对于超长列表，务必使用 `my.onPageScroll` 结合虚拟列表技术，只渲染可视区域内的几个元素，而不是一次性渲染所有数据。
3. **图片优化**：使用合适的图片格式（如 WebP）、对图片进行压缩、使用懒加载。



### 5. 开发与调试：从“眼见为实”到“工具依赖”

模拟器是基于 PC 环境模拟的，其 WebView 内核、系统行为、网络环境都与真机有差异。特别是 iOS 和 Android 的底层 WebView 实现不同，会导致兼容性问题。

不要过度依赖模拟器。在开发过程中，要频繁地在不同型号的真机（尤其是主流的 iOS 和 Android 机型）上进行预览和调试。

支付宝小程序开发者工具提供了性能分析、真机调试、API Mock 等强大功能。学会使用它们，能帮你快速定位问题。

：几乎所有小程序的 API 都是异步的。请务必为 `my.xxx` 这类 API 调用编写 `fail` 回调或使用 `Promise` 的 `catch`，否则错误会被“吞掉”，导致难以排查的静默失败。推荐使用 `async/await` 语法，配合 `try/catch`，让代码更清晰。



### 总结一下

作为一名前端开发者，进入支付宝小程序领域，最重要的是完成几个思维转变：

- 从 **DOM 操作**到 **数据驱动**。
- 从 **前端主导**到 **前后端协同**（特别是支付等敏感业务）。
- 从 **Web 通用**到 **平台特定**（尊重并利用好平台的规则和能力）。