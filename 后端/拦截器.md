åœ¨å¼€å‘åç«¯æœåŠ¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°ä¸€äº›é‡å¤æ€§çš„éœ€æ±‚ï¼šè®°å½•æ¯ä¸ªè¯·æ±‚çš„æ—¥å¿—ã€ç»Ÿè®¡æ¥å£å“åº”æ—¶é—´ã€ç»Ÿä¸€å¤„ç†è¿”å›æ•°æ®æ ¼å¼ï¼Œæˆ–è€…åœ¨æŸäº›æƒ…å†µä¸‹ç›´æ¥è¿”å›ç¼“å­˜æ•°æ®è€Œä¸æ‰§è¡Œå¤æ‚çš„ä¸šåŠ¡é€»è¾‘ã€‚è¿™äº›åœºæ™¯ç”¨ NestJS çš„æ‹¦æˆªå™¨æ¥å¤„ç†å¾ˆé€‚åˆã€‚

## ä»€ä¹ˆæ˜¯æ‹¦æˆªå™¨ï¼Ÿ
æ‹¦æˆªå™¨æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå®ç°äº† `NestInterceptor` æ¥å£çš„ç±»ï¼Œä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆåº”ç”¨ä¸­çš„"å®‰æ£€å£"æˆ–è€…"åŠ å·¥ç«™"ã€‚

å®ƒèƒ½å¤Ÿåœ¨è¯·æ±‚åˆ°è¾¾ä½ çš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä¹‹å‰æˆ–ä¹‹åæ’å…¥ä¸€äº›é¢å¤–çš„æ“ä½œã€‚



## æ‹¦æˆªå™¨èƒ½å¸®æˆ‘ä»¬åšä»€ä¹ˆï¼Ÿ
+ **å‰åå¤¹å‡»**ï¼šåœ¨ä½ çš„ä¸»è¦å¤„ç†æ–¹æ³•æ‰§è¡Œå‰ååŠ ä¸Šé¢å¤–é€»è¾‘ï¼Œæ¯”å¦‚æ‰“å°æ—¥å¿—ã€ç»Ÿè®¡è€—æ—¶ç­‰ã€‚
+ **æ•°æ®å˜èº«**ï¼šæ”¹å˜æ–¹æ³•è¿”å›çš„ç»“æœã€‚æ¯”å¦‚æŠŠæ‰€æœ‰è¿”å›æ•°æ®éƒ½åŒ…è£…åœ¨ä¸€ä¸ªç»Ÿä¸€çš„ `data` å­—æ®µé‡Œã€‚
+ **é”™è¯¯åŒ…è£…**ï¼šè½¬æ¢æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ï¼ŒæŠŠåŸå§‹çš„æ•°æ®åº“é”™è¯¯åŒ…è£…æˆç”¨æˆ·å‹å¥½çš„æç¤ºä¿¡æ¯ã€‚
+ **åŠŸèƒ½å¢å¼º**ï¼šç»™åŸºç¡€æ–¹æ³•è¡Œä¸ºåŠ ç‚¹æ–°èŠ±æ ·ï¼Œæ¯”å¦‚è‡ªåŠ¨å¤„ç†é‡å¤æ€§ä»»åŠ¡ã€‚
+ **ç›´æ¥æ¥ç®¡**ï¼šåœ¨ç‰¹å®šæ¡ä»¶ä¸‹ï¼ˆæ¯”å¦‚ç¼“å­˜å‘½ä¸­ï¼‰å®Œå…¨ä¸æ‰§è¡ŒåŸæ–¹æ³•ï¼Œç›´æ¥è¿”å›é¢„è®¾å€¼ã€‚



## æ‹¦æˆªå™¨çš„å·¥ä½œåŸç†
æ¯ä¸ªæ‹¦æˆªå™¨éƒ½å¿…é¡»å®ç° `intercept` æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ¥æ”¶ä¸¤ä¸ªé‡è¦å‚æ•°ï¼š

### context (ExecutionContext)
è¿™ä¸ªå‚æ•°ç»§æ‰¿è‡ª `ArgumentsHost`ï¼Œèƒ½è®©ä½ è·å–åŸå§‹è¯·æ±‚çš„å„ç§ä¿¡æ¯ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œå®ƒèƒ½å‘Šè¯‰ä½ å½“å‰è¯·æ±‚çš„"ä¸Šä¸‹æ–‡ç¯å¢ƒ" â€”â€” æ˜¯å“ªä¸ªæ§åˆ¶å™¨ã€å“ªä¸ªæ–¹æ³•åœ¨å¤„ç†è¯·æ±‚ï¼Œè¯·æ±‚ç±»å‹æ˜¯ HTTPã€WebSocket è¿˜æ˜¯ gRPC ç­‰ç­‰ã€‚å°±åƒè¿™æ¬¡è¯·æ±‚çš„"èº«ä»½è¯"ã€‚

### next (CallHandler)
è¿™ä¸ªå‚æ•°éå¸¸å…³é”®ã€‚å®ƒåŒ…å«ä¸€ä¸ª `handle()` æ–¹æ³•ã€‚å½“ä½ è°ƒç”¨ `next.handle()` æ—¶ï¼Œå°±ç›¸å½“äºå¯¹è¯·æ±‚è¯´"æ”¾è¡Œï¼"ï¼Œè®©è¯·æ±‚ç»§ç»­æ‰§è¡ŒåŸæœ¬çš„è·¯ç”±å¤„ç†å‡½æ•°ã€‚å¦‚æœä¸è°ƒç”¨å®ƒï¼Œè¯·æ±‚å°±ä¼šè¢«"å¡ä½"ï¼Œåç»­é€»è¾‘éƒ½ä¸ä¼šæ‰§è¡Œã€‚

`next.handle()` è¿”å›çš„æ˜¯ä¸€ä¸ª `Observable` å¯¹è±¡ï¼ˆæ¥è‡ª RxJS åº“ï¼‰ã€‚ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ªæ•°æ®ç®¡é“ï¼Œåˆ©ç”¨ RxJS æä¾›çš„å„ç§æ“ä½œç¬¦ï¼ˆå¦‚ `pipe()`ã€`tap()`ã€`map()` ç­‰ï¼‰æ¥å¯¹è¿™ä¸ª"æµ"è¿›è¡ŒåŠ å·¥å¤„ç†ã€‚  


## ğŸŒ° è®°å½•è¯·æ±‚è€—æ—¶
è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªè®°å½•è¯·æ±‚å¤„ç†æ—¶é—´çš„æ‹¦æˆªå™¨ï¼š

```typescript
// logging.interceptor.ts
import { Injectable, NestInterceptor, ExecutionContext, CallHandler, Logger } from '@nestjs/common';
import { Observable } from 'rxjs';
import { tap } from 'rxjs/operators';

@Injectable()
export class LoggingInterceptor implements NestInterceptor {
  private readonly logger = new Logger(LoggingInterceptor.name);

  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    const request = context.switchToHttp().getRequest();
    const method = request.method;
    const url = request.url;
    this.logger.log(`[${method}] ${url} - è¯·æ±‚å¤„ç†å¼€å§‹...`);

    const now = Date.now();
    return next
      .handle()
      .pipe(
        tap(() => 
          this.logger.log(`[${method}] ${url} - è¯·æ±‚å¤„ç†å®Œæ¯•... è€—æ—¶ ${Date.now() - now} ms`)
        )
      );
  }
}
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼š

+ `next.handle()` ä¹‹å‰çš„ä»£ç ä¼šåœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œå‰è¿è¡Œ
+ `tap()` æ“ä½œç¬¦ä¸­çš„å›è°ƒå‡½æ•°ä¼šåœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œå®Œæ¯•åè¿è¡Œ



## å¦‚ä½•ä½¿ç”¨æ‹¦æˆªå™¨ï¼Ÿ
ä½¿ç”¨ `@UseInterceptors()` è£…é¥°å™¨ï¼Œä½ å¯ä»¥åœ¨ä¸åŒèŒƒå›´å†…åº”ç”¨æ‹¦æˆªå™¨ï¼š

### æ§åˆ¶å™¨èŒƒå›´
```typescript
// LoggingInterceptor ä¼šåº”ç”¨åˆ° CatsController ä¸‹çš„æ‰€æœ‰è·¯ç”±å¤„ç†æ–¹æ³•
@UseInterceptors(LoggingInterceptor)
@Controller('cats')
export class CatsController {
  @Get()
  findAll() {
    return 'æ‰€æœ‰çš„å°çŒ«å’ªéƒ½åœ¨è¿™é‡Œï¼';
  }

  @Post()
  create(@Body() catInfo: any) {
    return `åˆ›å»ºäº†ä¸€åªæ–°çŒ«ï¼š${catInfo.name}`;
  }
}
```

### æ–¹æ³•èŒƒå›´
```typescript
@Controller('cats')
export class CatsController {
  @Get()
  findAll() {
    return 'æ‰€æœ‰çš„å°çŒ«å’ªéƒ½åœ¨è¿™é‡Œï¼';
  }

  @UseInterceptors(LoggingInterceptor) // åªå¯¹ create æ–¹æ³•ç”Ÿæ•ˆ
  @Post()
  create(@Body() catInfo: any) {
    return `åˆ›å»ºäº†ä¸€åªæ–°çŒ«ï¼š${catInfo.name}`;
  }
}
```

### å…¨å±€èŒƒå›´
**æ–¹æ³•ä¸€ï¼š**åœ¨ `main.ts` æ–‡ä»¶é‡Œï¼Œç›´æ¥ä½¿ç”¨ `app.useGlobalInterceptors()`ã€‚

```typescript
// main.ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { LoggingInterceptor } from './logging.interceptor'; // å‡è®¾æ‹¦æˆªå™¨åœ¨è¿™é‡Œ

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  // å…¨å±€ç”Ÿæ•ˆï¼Œä½†è¿™æ · new å‡ºæ¥çš„ LoggingInterceptor ä¸èƒ½æ³¨å…¥å…¶ä»–ä¾èµ–
  app.useGlobalInterceptors(new LoggingInterceptor()); 
  await app.listen(3000);
}
bootstrap();
```

è¿™ç§æ–¹å¼ç®€å•ç›´æ¥ï¼Œä½†æœ‰ä¸ªç¼ºç‚¹ï¼šå¦‚æœä½ çš„ `LoggingInterceptor` éœ€è¦æ³¨å…¥å…¶ä»–æœåŠ¡ (æ¯”å¦‚ä¸€ä¸ªé…ç½®æœåŠ¡æˆ–æ•°æ®åº“æœåŠ¡)ï¼Œè¿™ç§æ–¹å¼å°±æä¸å®šäº†ã€‚

**æ–¹æ³•äºŒ (æ¨è)**ï¼šåœ¨æ¨¡å—ä¸­æ³¨å†Œå…¨å±€æ‹¦æˆªå™¨ï¼Œè¿™æ ·æ”¯æŒä¾èµ–æ³¨å…¥ï¼š

```typescript
// app.module.ts
import { Module } from '@nestjs/common';
import { APP_INTERCEPTOR } from '@nestjs/core';
import { LoggingInterceptor } from './logging.interceptor';

@Module({
  providers: [
    {
      provide: APP_INTERCEPTOR, // è¿™æ˜¯ä¸€ä¸ªå›ºå®šçš„ Tokenï¼Œå‘Šè¯‰ Nest è¿™æ˜¯ä¸ªå…¨å±€æ‹¦æˆªå™¨
      useClass: LoggingInterceptor, // æŒ‡å®šç”¨å“ªä¸ªæ‹¦æˆªå™¨ç±»
    },
  ],
})
export class AppModule {}
```



## æ•°æ®è½¬æ¢ï¼šç»Ÿä¸€å“åº”æ ¼å¼
å¾ˆå¤šæ—¶å€™æˆ‘ä»¬å¸Œæœ› API è¿”å›çš„æ•°æ®æœ‰ç»Ÿä¸€æ ¼å¼ï¼Œæ¯”å¦‚æ‰€æœ‰æˆåŠŸå“åº”éƒ½åŒ…è£…åœ¨ `data` å±æ€§é‡Œï¼š

```typescript
// transform.interceptor.ts
import { Injectable, NestInterceptor, ExecutionContext, CallHandler } from '@nestjs/common';
import { Observable } from 'rxjs';
import { map } from 'rxjs/operators';

// å®šä¹‰ä¸€ä¸‹æˆ‘ä»¬æœŸæœ›çš„å“åº”ç»“æ„
export interface Response<T> {
  statusCode: number; // é€šå¸¸ HTTP çŠ¶æ€ç ç”±æ¡†æ¶å¤„ç†ï¼Œè¿™é‡Œå¯ä»¥åŠ ä¸šåŠ¡çŠ¶æ€ç 
  message?: string;
  data: T;
}

@Injectable()
export class TransformInterceptor<T> implements NestInterceptor<T, Response<T>> {
  intercept(context: ExecutionContext, next: CallHandler): Observable<Response<T>> {
    return next.handle().pipe(
      // map æ“ä½œç¬¦ï¼šæ‹¿åˆ°åŸå§‹è·¯ç”±å¤„ç†å‡½æ•°è¿”å›çš„æ•°æ® (data)ï¼ŒæŠŠå®ƒè½¬æ¢æˆæ–°æ ¼å¼
      map(data => ({
        statusCode: context.switchToHttp().getResponse().statusCode, // è·å– HTTP çŠ¶æ€ç 
        message: 'è¯·æ±‚æˆåŠŸ', // æˆ–è€…æ ¹æ®å®é™…æƒ…å†µè®¾ç½®
        data: data // æŠŠåŸå§‹æ•°æ®æ”¾åˆ° data å­—æ®µé‡Œ
      }))
    );
  }
}
```

å¦‚æœä½ çš„è·¯ç”±å¤„ç†å‡½æ•°è¿”å› `['æ©˜çŒ«', 'ç‹¸èŠ±çŒ«']`ï¼Œåº”ç”¨è¿™ä¸ªæ‹¦æˆªå™¨åï¼Œå®¢æˆ·ç«¯æ”¶åˆ°çš„å“åº”ä¼šæ˜¯ï¼š

```json
{
  "statusCode": 200,
  "message": "è¯·æ±‚æˆåŠŸ",
  "data": ["æ©˜çŒ«", "ç‹¸èŠ±çŒ«"]
}
```

**è¯·æ³¨æ„**ï¼šè¿™ç§å“åº”æ˜ å°„çš„æ‹¦æˆªå™¨ï¼Œå¯¹äºé‚£äº›ç›´æ¥ä½¿ç”¨ `@Res()` è£…é¥°å™¨æ¥æ“ä½œåº•å±‚å“åº”å¯¹è±¡ (æ¯”å¦‚ `res.send()` æˆ– `res.json()`) çš„è·¯ç”±å¤„ç†æ–¹æ³•æ˜¯**æ— æ•ˆ**çš„ã€‚å› ä¸ºä¸€æ—¦ä½ ç”¨äº† `@Res()`ï¼Œä½ å°±å…¨é¢æ¥ç®¡äº†å“åº”æµç¨‹ï¼ŒNest çš„è¿™ç§æ ‡å‡†å“åº”å¤„ç†æœºåˆ¶ï¼ˆåŒ…æ‹¬æ‹¦æˆªå™¨å¯¹å“åº”çš„ä¿®æ”¹ï¼‰å°±ä¼šè¢«ç»•è¿‡ã€‚



## é”™è¯¯å¤„ç†ï¼šä¼˜é›…åœ°æ•è·å¼‚å¸¸
å½“ä¸šåŠ¡é€»è¾‘æŠ›å‡ºé”™è¯¯æ—¶ï¼Œæ‹¦æˆªå™¨å¯ä»¥ä¼˜é›…åœ°æ¥ä½å¹¶è½¬æ¢å®ƒä»¬ï¼š

```typescript
// errors.interceptor.ts
import {
  Injectable,
  NestInterceptor,
  ExecutionContext,
  CallHandler,
  BadGatewayException,
  Logger,
} from '@nestjs/common';
import { Observable, throwError } from 'rxjs';
import { catchError } from 'rxjs/operators';

@Injectable()
export class ErrorsInterceptor implements NestInterceptor {
  private readonly logger = new Logger(ErrorsInterceptor.name);

  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    return next.handle().pipe(
      catchError(err => {
        this.logger.error(`ç³Ÿç³•ï¼Œå‡ºé”™äº†ï¼åŸå§‹é”™è¯¯: ${err.message}`, err.stack);
        
        return throwError(() => new BadGatewayException('å“¦è±ï¼ŒæœåŠ¡å™¨å¥½åƒå¼€å°å·®äº†...è¯·ç¨åå†è¯•ï¼'));
      })
    );
  }
}
```

è¿™æ ·ï¼Œå³ä¾¿æ˜¯ç¨‹åºå†…éƒ¨æŠ›å‡ºäº†ä¸€ä¸ªå¾ˆåŸå§‹çš„é”™è¯¯ï¼Œç»è¿‡è¿™ä¸ªæ‹¦æˆªå™¨çš„â€œåŒ…è£…â€ï¼Œå®¢æˆ·ç«¯æœ€ç»ˆåªä¼šæ”¶åˆ°ä¸€ä¸ªç»Ÿä¸€çš„ã€ç›¸å¯¹å‹å¥½çš„ `BadGatewayException` å“åº”ã€‚



## é«˜çº§åº”ç”¨ï¼šç¼“å­˜å’Œè¶…æ—¶å¤„ç†
### ç¼“å­˜å®ç°
```typescript
// cache.interceptor.ts (è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€åŒ–çš„ç¤ºä¾‹)
import { Injectable, NestInterceptor, ExecutionContext, CallHandler, Logger } from '@nestjs/common';
import { Observable, of } from 'rxjs'; // of æ“ä½œç¬¦å¯ä»¥åˆ›å»ºä¸€ä¸ªç«‹å³å‘å‡ºæŒ‡å®šå€¼çš„ Observable
import { tap } from 'rxjs/operators';

// å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç®€å•çš„å†…å­˜ç¼“å­˜æœåŠ¡
const cache = new Map<string, any>();

@Injectable()
export class CacheInterceptor implements NestInterceptor {
  private readonly logger = new Logger(CacheInterceptor.name);

  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    const request = context.switchToHttp().getRequest();
    const cacheKey = `${request.method}_${request.url}`;
    
    const cachedResponse = cache.get(cacheKey);
    if (cachedResponse) {
      this.logger.log(`å‘½ä¸­ç¼“å­˜ [${cacheKey}]ï¼Œç›´æ¥è¿”å›ï¼`);
      // å¦‚æœç¼“å­˜å‘½ä¸­ï¼Œå°±ç”¨ of() ç›´æ¥åˆ›å»ºä¸€ä¸ªåŒ…å«ç¼“å­˜æ•°æ®çš„ Observable å¹¶è¿”å›
      // è¿™æ ·å°±ä¸ä¼šæ‰§è¡Œ next.handle()ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šæ‰§è¡ŒçœŸæ­£çš„è·¯ç”±å¤„ç†å‡½æ•°äº†
      return of(cachedResponse); 
    }

    this.logger.log(`ç¼“å­˜æœªå‘½ä¸­ [${cacheKey}]ï¼Œç»§ç»­æ‰§è¡Œ...`);
    // ç¼“å­˜æœªå‘½ä¸­ï¼Œæ­£å¸¸æ‰§è¡Œè·¯ç”±å¤„ç†å‡½æ•°
    return next.handle().pipe(
      tap(response => {
        // å°†ç»“æœå­˜å…¥ç¼“å­˜ï¼Œå¯ä»¥è®¾ç½®è¿‡æœŸæ—¶é—´ç­‰å¤æ‚é€»è¾‘
        cache.set(cacheKey, response);
        this.logger.log(`å·²ç¼“å­˜å“åº”æ•°æ® [${cacheKey}]`);
      })
    );
  }
}
```

åœ¨è¿™ä¸ªç®€åŒ–ç‰ˆ `CacheInterceptor` ä¸­ï¼Œå¦‚æœç¼“å­˜å‘½ä¸­ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨ RxJS çš„ `of()` æ“ä½œç¬¦ç›´æ¥åˆ›å»ºä¸€ä¸ªåŒ…å«ç¼“å­˜æ•°æ®çš„ `Observable` å¹¶è¿”å›ï¼Œä»è€Œâ€œæˆªèƒ¡â€æ‰åŸæ¥çš„ `next.handle()` è°ƒç”¨ï¼Œè¯·æ±‚ä¸ä¼šåˆ°è¾¾çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘å¤„ç†å‡½æ•°ã€‚

### è¶…æ—¶å¤„ç†
```typescript
// timeout.interceptor.ts
import { 
  Injectable, 
  NestInterceptor, 
  ExecutionContext, 
  CallHandler, 
  RequestTimeoutException, // Nest å†…ç½®çš„è¯·æ±‚è¶…æ—¶å¼‚å¸¸
  Logger,
} from '@nestjs/common';
import { Observable, throwError, TimeoutError } from 'rxjs'; // TimeoutError æ˜¯ RxJS æŠ›å‡ºçš„é”™è¯¯ç±»å‹
import { catchError, timeout } from 'rxjs/operators';

@Injectable()
export class TimeoutInterceptor implements NestInterceptor {
  private readonly logger = new Logger(TimeoutInterceptor.name);

  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    return next.handle().pipe(
      timeout(5000), // è®¾ç½® 5 ç§’è¶…æ—¶ï¼Œå¦‚æœ 5 ç§’å†…æ²¡å“åº”ï¼Œå°±ä¼šæŠ›å‡º TimeoutError
      catchError(err => {
        if (err instanceof TimeoutError) {
          this.logger.warn('è¯·æ±‚å¤„ç†è¶…æ—¶ï¼');
          // å¦‚æœæ˜¯è¶…æ—¶é”™è¯¯ï¼Œå°±æŠ›å‡º Nest å†…ç½®çš„ RequestTimeoutException
          return throwError(() => new RequestTimeoutException('è¯·æ±‚è¶…æ—¶å•¦ï¼Œè¯·ç¨åå†è¯•ï¼'));
        }
        // å¦‚æœæ˜¯å…¶ä»–ç±»å‹çš„é”™è¯¯ï¼Œå°±ç»§ç»­å‘ä¸ŠæŠ›ï¼Œè®©å…¶ä»–é”™è¯¯å¤„ç†æœºåˆ¶æ¥æ‰‹
        return throwError(() => err);
      }),
    );
  }
}
```

å½“è¯·æ±‚å¤„ç†æ—¶é—´è¶…è¿‡ 5 ç§’ï¼Œè¿™ä¸ªæ‹¦æˆªå™¨å°±ä¼šæ•è·åˆ° `TimeoutError`ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºä¸€ä¸ªæ ‡å‡†çš„ `RequestTimeoutException` è¿”å›ç»™å®¢æˆ·ç«¯ã€‚





## RxJS åˆè¯†
RxJS æ˜¯ä¸€ä¸ªç»„ç»‡å¼‚æ­¥é€»è¾‘çš„åº“ï¼Œå®ƒæœ‰å¾ˆå¤š operatorï¼Œå¯ä»¥æå¤§çš„ç®€åŒ–å¼‚æ­¥é€»è¾‘çš„ç¼–å†™ã€‚

å®ƒæ˜¯ç”±æ•°æ®æºï¼ˆobservableï¼‰äº§ç”Ÿæ•°æ®ï¼Œç»è¿‡ä¸€ç³»åˆ— operator çš„å¤„ç†ï¼Œæœ€åä¼ ç»™æ¥æ”¶è€…ã€‚

æ¯”å¦‚è¿™æ ·ï¼š

![](https://cdn.nlark.com/yuque/0/2023/png/21596389/1687068181380-d1bee459-b838-4867-b2c3-d93ace9ab220.png)

è°ƒç”¨ of æ“ä½œç¬¦åˆ›å»ºä¸€ä¸ª Observableï¼Œå®ƒå‘é€äº†ä¸‰ä¸ªå€¼ 1ã€2ã€3ã€‚

ä½¿ç”¨ pipe æ–¹æ³•ï¼Œå°† map æ“ä½œç¬¦æ·»åŠ åˆ° Observable ä¸Šï¼Œå¯¹æ¯ä¸ªè¾“å…¥å€¼è¿›è¡Œå¹³æ–¹è¿ç®—ï¼Œå¾—åˆ°ä¸€ä¸ªæ–°çš„ Observableï¼Œå®ƒå‘é€äº† 1ã€4ã€9ã€‚

å†æ¬¡ä½¿ç”¨ pipe æ–¹æ³•ï¼Œå°† filter æ“ä½œç¬¦æ·»åŠ åˆ° Observable ä¸Šï¼Œè¿‡æ»¤æ‰æ‰€æœ‰å¶æ•°å€¼ï¼Œå¾—åˆ°ä¸€ä¸ªæ–°çš„ Observableï¼Œå®ƒå‘é€äº† 1ã€9ã€‚

æœ€åï¼Œè°ƒç”¨ subscribe æ–¹æ³•è®¢é˜…è¿™ä¸ª Observableï¼Œå½“å®ƒå‘é€æ–°å€¼æ—¶ï¼Œè°ƒç”¨æä¾›çš„å›è°ƒå‡½æ•°è¾“å‡ºç»“æœã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå›è°ƒå‡½æ•°è¾“å‡ºäº†æ¯ä¸ªæ¥æ”¶åˆ°çš„å€¼ã€‚



ç»§ç»­çœ‹è¿™æ®µä»£ç ï¼š

![](https://cdn.nlark.com/yuque/0/2023/png/21596389/1687068532575-0df9555c-0ead-4b1f-8dc2-fc7bea1ee8b6.png)

è°ƒç”¨ of æ“ä½œç¬¦åˆ›å»ºä¸€ä¸ª Observableï¼Œå®ƒå‘é€äº†ä¸‰ä¸ªå€¼ 1ã€2ã€3ã€‚

ä½¿ç”¨ pipe æ–¹æ³•ï¼Œå°† scan æ“ä½œç¬¦æ·»åŠ åˆ° Observable ä¸Šï¼Œå¯¹æ¯ä¸ªè¾“å…¥å€¼è¿›è¡Œç´¯åŠ æ“ä½œï¼Œå¾—åˆ°ä¸€ä¸ªæ–°çš„ Observableï¼Œå®ƒåœ¨æ¯æ¬¡æ¥æ”¶åˆ°å€¼æ—¶éƒ½ä¼šå‘å‡ºç´¯åŠ ç»“æœã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œç¬¬ä¸€ä¸ªå€¼æ˜¯ 1ï¼Œç¬¬äºŒä¸ªå€¼æ˜¯ 1 + 2 = 3ï¼Œç¬¬ä¸‰ä¸ªå€¼æ˜¯ 1 + 2 + 3 = 6ã€‚

å†æ¬¡ä½¿ç”¨ pipe æ–¹æ³•ï¼Œå°† map æ“ä½œç¬¦æ·»åŠ åˆ° Observable ä¸Šï¼Œå¯¹æ¯ä¸ªç´¯åŠ ç»“æœè¿›è¡Œå¹³å‡æ•°è®¡ç®—ï¼Œå¾—åˆ°ä¸€ä¸ªæ–°çš„ Observableï¼Œå®ƒåœ¨æ¯æ¬¡æ¥æ”¶åˆ°å€¼æ—¶éƒ½ä¼šå‘å‡ºå¹³å‡æ•°ç»“æœã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œç¬¬ä¸€ä¸ªå€¼æ˜¯ 1ï¼Œç¬¬äºŒä¸ªå€¼æ˜¯ (1 + 2) / 2 = 1.5ï¼Œç¬¬ä¸‰ä¸ªå€¼æ˜¯ (1 + 2 + 3) / 3 = 2ã€‚

æœ€åï¼Œè°ƒç”¨ subscribe æ–¹æ³•è®¢é˜…è¿™ä¸ª Observableï¼Œå½“å®ƒå‘é€æ–°å€¼æ—¶ï¼Œè°ƒç”¨æä¾›çš„å›è°ƒå‡½æ•°è¾“å‡ºç»“æœã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå›è°ƒå‡½æ•°è¾“å‡ºäº†æ¯ä¸ªæ¥æ”¶åˆ°çš„å¹³å‡æ•°ç»“æœã€‚



å†æ¥çœ‹èŠ‚æµã€é˜²æŠ–ï¼š

![](https://cdn.nlark.com/yuque/0/2023/png/21596389/1687068935576-811a596a-c1c9-42b5-b435-637f7e36dad9.png)

![](https://cdn.nlark.com/yuque/0/2023/png/21596389/1687068960425-9f7ab213-f00c-4637-8e6c-cc327743c833.png)

å¯ä»¥åœ¨å®˜ç½‘æ–‡æ¡£çœ‹åˆ°[æ‰€æœ‰çš„ operator](https://link.juejin.cn/?target=https%3A%2F%2Frxjs.dev%2Fguide%2Foperators%23creation-operators-1)ã€‚

å¦‚æœå¼‚æ­¥é€»è¾‘å¤æ‚åº¦é«˜ï¼Œ RxJS æ”¶ç›Šè¿˜æ˜¯å¾ˆé«˜çš„ã€‚

Nest çš„ interceptor é›†æˆäº† RxJSï¼Œå¯ä»¥ç”¨å®ƒæ¥å¤„ç†å“åº”ã€‚



## Nest ä¸­ä½¿ç”¨ RxJS
### map
map æ“ä½œç¬¦å…è®¸å¯¹ä»è¯·æ±‚å¤„ç†ç¨‹åºè¿”å›çš„æ•°æ®è¿›è¡Œè½¬æ¢ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨å®ƒå°†æ•°æ®åŒ…è£…åœ¨ä¸€ä¸ªæ ‡å‡†çš„å“åº”å¯¹è±¡ä¸­ï¼Œè¯¥å¯¹è±¡åŒ…å«çŠ¶æ€ç ã€æ¶ˆæ¯å’Œæ•°æ®ã€‚

ç”Ÿæˆä¸€ä¸ª interceptorï¼š

```bash
nest g interceptor map-test --flat --no-spec
```

ä½¿ç”¨ map operator å¯¹ controller è¿”å›çš„æ•°æ®åšä¸€äº›ä¿®æ”¹ï¼š

```javascript
import {
  CallHandler,
  ExecutionContext,
  Injectable,
  NestInterceptor,
} from '@nestjs/common';
import { Observable } from 'rxjs';
import { map } from 'rxjs/operators';

@Injectable()
export class MapTestInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    return next.handle().pipe(
      map((data) => {
        return {
          code: 200,
          message: 'success',
          data,
        };
      }),
    );
  }
}
```

 controller ä¸‹å¯ç”¨ï¼š

![](https://cdn.nlark.com/yuque/0/2023/png/21596389/1687071404488-d423f7ec-e3b6-4a37-9bd7-d3d9578e4266.png)

è¯·æ±‚æ¥å£ï¼š

![](https://cdn.nlark.com/yuque/0/2023/png/21596389/1687071422542-667a9a62-700f-42c8-bcc3-94790d2396f5.png)





### tap
tap æ“ä½œç¬¦å…è®¸åœ¨ä¸ä¿®æ”¹æ•°æ®æµçš„æƒ…å†µä¸‹æ‰§è¡Œå‰¯ä½œç”¨æ“ä½œï¼Œæ¯”å¦‚è®°å½•æ—¥å¿—æˆ–æ›´æ–°ç¼“å­˜ã€‚

è¿™å¯¹äºåœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­æ·»åŠ é¢å¤–çš„æ—¥å¿—è®°å½•æˆ–è°ƒè¯•ä¿¡æ¯éå¸¸æœ‰ç”¨ã€‚

å†ç”Ÿæˆä¸ª interceptor

```bash
nest g interceptor tap-test --flat --no-spec
```

ä½¿ç”¨ tap operator æ¥æ·»åŠ ä¸€äº›æ—¥å¿—ã€ç¼“å­˜ç­‰é€»è¾‘ï¼š

```javascript
import { AppService } from './app.service';
import {
  CallHandler,
  ExecutionContext,
  Injectable,
  Logger,
  NestInterceptor,
} from '@nestjs/common';
import { Observable } from 'rxjs';
import { tap } from 'rxjs/operators';

@Injectable()
export class TapTestInterceptor implements NestInterceptor {
  constructor(private appService: AppService) {}

  private readonly logger = new Logger(TapTestInterceptor.name);

  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    return next.handle().pipe(
      tap((data) => {
        // è¿™é‡Œå‡è£…ä¸‹æ›´æ–°ç¼“å­˜çš„æ“ä½œ
        this.appService.getHello();

        this.logger.log(`log something`, data);
      }),
    );
  }
}
```

åœ¨ controller è¿”å›å“åº”çš„æ—¶å€™è®°å½•ä¸€äº›ä¸œè¥¿ã€‚

![](https://cdn.nlark.com/yuque/0/2023/png/21596389/1687071750460-49205b36-9ded-452b-93bb-117a97be05a3.png)

![](https://cdn.nlark.com/yuque/0/2023/png/21596389/1687071724570-99459155-431b-400b-887f-3e063737aad6.png)



### catchError
catchError æ“ä½œç¬¦å…è®¸å¤„ç†åœ¨è¯·æ±‚å¤„ç†ç¨‹åºä¸­æŠ›å‡ºçš„å¼‚å¸¸ã€‚

å¯ä»¥å…ˆåœ¨æ‹¦æˆªå™¨ä¸­æ•è·è¿™äº›å¼‚å¸¸ï¼Œå¹¶æ‰§è¡Œä¸€äº›é¢å¤–çš„é€»è¾‘ï¼Œæ¯”å¦‚è®°å½•é”™è¯¯æ—¥å¿—æˆ–è¿”å›è‡ªå®šä¹‰çš„é”™è¯¯å“åº”ã€‚

ç”Ÿæˆ interceptorï¼š

```bash
nest g interceptor catch-error-test --flat --no-spec
```

ä½¿ç”¨ catchError å¤„ç†æŠ›å‡ºçš„å¼‚å¸¸ï¼š

```typescript
import {
  CallHandler,
  ExecutionContext,
  Injectable,
  Logger,
  NestInterceptor,
} from '@nestjs/common';
import { Observable, throwError } from 'rxjs';
import { catchError } from 'rxjs/operators';

@Injectable()
export class CatchErrorTestInterceptor implements NestInterceptor {
  private readonly logger = new Logger(CatchErrorTestInterceptor.name);

  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    return next.handle().pipe(
      // ä½¿ç”¨ catchError æ“ä½œç¬¦æ¥æ•è·å¼‚å¸¸
      catchError((err) => {
        this.logger.error(err.message, err.stack);

         // é‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œè®©å®ƒå¯ä»¥è¢«åç»­çš„é”™è¯¯å¤„ç†å™¨æ•è·
        return throwError(() => err);
      }),
    );
  }
}
```

åœ¨ controller ä½¿ç”¨ä¸‹ï¼š

![](https://cdn.nlark.com/yuque/0/2023/png/21596389/1687072039431-c5a1d7e6-b744-4ce7-ac02-dc5cffe62f3b.png)

![](https://cdn.nlark.com/yuque/0/2023/png/21596389/1687072018764-cf299ae1-ccbf-496d-9b6d-39d74c523f32.png)

è¿™ä¸ª 500 é”™è¯¯ï¼Œæ˜¯å†…ç½®çš„ exception filter å¤„ç†çš„ï¼š

nest æ§åˆ¶å°ä¼šæ‰“å°ä¸¤æ¬¡é”™è¯¯ï¼ŒæŠ¥é”™ä¿¡æ¯éƒ½æ˜¯ xxxã€‚

ä¸€æ¬¡æ˜¯æˆ‘ä»¬åœ¨ interceptor é‡Œæ‰“å°çš„ï¼Œä¸€æ¬¡æ˜¯ exception filter æ‰“å°çš„ã€‚



### timeout
timeout æ“ä½œç¬¦å…è®¸ä¸ºè¯·æ±‚å¤„ç†ç¨‹åºè®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´ã€‚

å¦‚æœåœ¨æŒ‡å®šçš„æ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°å“åº”ï¼Œå®ƒå°†æŠ›å‡ºä¸€ä¸ª TimeoutError å¼‚å¸¸ã€‚

å¯ä»¥ç»“åˆ catchError æ“ä½œç¬¦æ¥å¤„ç†è¿™ä¸ªå¼‚å¸¸ï¼Œå¹¶è¿”å›ä¸€ä¸ªé€‚å½“çš„è¶…æ—¶å“åº”ã€‚

åˆ›å»º interceptorï¼š

```typescript
nest g interceptor timeout --flat --no-spec
```

æ·»åŠ å¦‚ä¸‹é€»è¾‘ï¼š

```typescript
import {
  Injectable,
  NestInterceptor,
  ExecutionContext,
  CallHandler,
  HttpException,
  HttpStatus,
} from '@nestjs/common';
import { Observable, TimeoutError, throwError } from 'rxjs';
import { catchError, timeout } from 'rxjs/operators';

@Injectable()
export class TimeoutInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    // è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º3ç§’
    const TIMEOUT = 3000;

    return next.handle().pipe(
      timeout(TIMEOUT), // åœ¨3ç§’åå¦‚æœè¿˜æ²¡æœ‰å“åº”ï¼Œåˆ™æŠ›å‡ºTimeoutError
      catchError((error) => {
        if (error instanceof TimeoutError) {
          // å¦‚æœæ•è·åˆ°è¶…æ—¶é”™è¯¯ï¼Œåˆ™æŠ›å‡ºHttpException
          return throwError(
            () => new HttpException('è¯·æ±‚è¶…æ—¶', HttpStatus.REQUEST_TIMEOUT),
          );
        }
        // å¦‚æœæ˜¯å…¶ä»–ç±»å‹çš„é”™è¯¯ï¼Œåˆ™ç»§ç»­æŠ›å‡º
        return throwError(() => error);
      }),
    );
  }
}
```

è¿™æ · timeout æ“ä½œç¬¦ä¼šåœ¨ 3s æ²¡æ”¶åˆ°æ¶ˆæ¯çš„æ—¶å€™æŠ›ä¸€ä¸ªé”™è¯¯ã€‚



åœ¨ controller ä½¿ç”¨ä¸‹ï¼š

![](https://cdn.nlark.com/yuque/0/2023/png/21596389/1687072435684-140990b4-f0e2-441b-ba06-28f69617a9ad.png)

æµè§ˆå™¨è®¿é—®ï¼Œ3s åè¿”å› 408 å“åº”ï¼š

![](https://cdn.nlark.com/yuque/0/2024/png/21596389/1708948340028-600f9581-150a-4ba0-a8dd-e8e02f8e5727.png)
