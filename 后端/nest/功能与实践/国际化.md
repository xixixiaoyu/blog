在全球化的今天，一个成功的 Web 应用往往需要面向不同国家和地区的用户。

想象一下，当一个英文用户兴致勃勃地使用你的应用时，突然弹出"用户不存在"这样的中文错误提示，那种困惑感可想而知。

这就是为什么国际化（i18n）功能如此重要的原因。

## 为什么需要后端国际化？
很多开发者认为国际化只是前端的事情，但这种想法是不完整的。

后端的错误提示、验证消息、邮件内容等同样需要根据用户的语言偏好进行本地化。

一个完整的国际化方案应该覆盖整个技术栈。

## 快速开始：搭建基础项目
首先，创建一个新的 Nest 项目：

```bash
nest new nest-i18n-test -p pnpm
cd nest-i18n-test
```

安装核心的国际化包：

```bash
pnpm i nestjs-i18n
```

## 核心配置：让应用理解多语言
在 `AppModule` 中配置 I18nModule：

```typescript
import { Module } from '@nestjs/common';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { I18nModule, QueryResolver } from 'nestjs-i18n';
import * as path from 'path';

@Module({
  imports: [
    I18nModule.forRoot({
      fallbackLanguage: 'en', // 默认语言
      loaderOptions: {
        path: path.join(__dirname, '/i18n/'), // 语言文件路径
        watch: true, // 开发时监听文件变化
      },
      resolvers: [new QueryResolver(['lang', 'l'])], // 通过查询参数 lang 或者 l 切换语言
    }),
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

## 创建语言资源文件
在 `src` 目录下创建 `i18n` 文件夹，然后按语言分别创建资源文件：

**i18n/en/test.json**：

```json
{
  "hello": "Hello World"
}
```

**i18n/zh/test.json**：

```json
{
  "hello": "你好世界"
}
```

在 `nest-cli.json` 中配置资源文件的自动复制（需在 `compilerOptions.assets` 下配置）：

```json
{
  "compilerOptions": {
    "assets": [
      { "include": "i18n/**/*", "watchAssets": true }
    ]
  }
}
```

![](https://cdn.nlark.com/yuque/0/2025/png/21596389/1749475727792-96891524-06d1-4baa-a3aa-52ed82fb994e.png)

保证打包后的 dist 文件夹，部署在生产环境能够看到国际化：

![](https://cdn.nlark.com/yuque/0/2025/png/21596389/1749538460630-87053b6d-a597-495f-ba59-f5bc89158677.png)

## 在服务中使用国际化
修改 `AppService` 来使用国际化服务：

```typescript
import { Inject, Injectable } from '@nestjs/common';
import { I18nContext, I18nService } from 'nestjs-i18n';

@Injectable()
export class AppService {
  constructor(private readonly i18n: I18nService) {}

  getHello(): string {
    return this.i18n.t('test.hello');
  }
}
```

启动项目：

```bash
pnpm run start:dev
```

访问 `http://localhost:3000?lang=zh` 会看到中文：

![](https://cdn.nlark.com/yuque/0/2025/png/21596389/1749475760737-15209c29-fe3e-4a6b-8dd6-ea029f61b9ae.png)

访问 `http://localhost:3000?lang=en` 会看到英文：

![](https://cdn.nlark.com/yuque/0/2025/png/21596389/1749475765011-2fc96f13-1f1e-4256-aa43-129dfbfb6855.png)

## 多样化的语言检测方式
除了查询参数，nestjs-i18n 还支持多种语言检测方式：

```typescript
import {
  AcceptLanguageResolver,
  CookieResolver,
  HeaderResolver,
  I18nModule,
  QueryResolver,
} from 'nestjs-i18n';

@Module({
  imports: [
    I18nModule.forRoot({
      fallbackLanguage: 'en',
      loaderOptions: {
        path: path.join(__dirname, '/i18n/'),
        watch: true,
      },
      // 从上往下匹配
      resolvers: [
        new QueryResolver(['lang', 'l']), // URL 参数
        new HeaderResolver(['x-custom-lang']), // 自定义请求头
        new CookieResolver(['lang']), // Cookie
        AcceptLanguageResolver, // 浏览器语言偏好
      ],
    }),
  ],
  // ...
})
export class AppModule {}
```

这样配置后，应用会按照解析器的顺序依次尝试检测用户的语言偏好，非常灵活。

可以在 Postman 中测试 cookie 解析器，通过添加 cookie 来切换语言：

![](https://cdn.nlark.com/yuque/0/2025/png/21596389/1749475885721-325bf4f6-604a-4ef2-a58f-eabb778e149c.png)

![](https://cdn.nlark.com/yuque/0/2025/png/21596389/1749475888918-a7f44a00-d7f6-46e1-b574-f3ef490887df.png)

加一个 lang=zh：

![](https://cdn.nlark.com/yuque/0/2025/png/21596389/1749475897253-54c6061c-a6a0-42f1-a6e1-4eb341e0013c.png)

返回就变成中文了：

![](https://cdn.nlark.com/yuque/0/2025/png/21596389/1749475904752-0dd349e0-c7d9-4c0a-a33c-e73b0c06400c.png)

## 表单验证的国际化处理
在实际项目中，表单验证消息的国际化是一个常见需求。首先安装验证相关的包：

```bash
pnpm install class-validator class-transformer
```

创建一个用户模块：

```bash
nest g resource user
```

在 DTO 中使用国际化验证消息：

```typescript
import { IsNotEmpty, MinLength } from "class-validator";
import { i18nValidationMessage } from 'nestjs-i18n';

export class CreateUserDto {
  @IsNotEmpty({
    message: i18nValidationMessage('validate.usernameNotEmpty')
  })
  username: string;
  
  @IsNotEmpty({
    message: i18nValidationMessage('validate.passwordNotEmpty')
  })
  @MinLength(6, {
    message: i18nValidationMessage('validate.passwordNotLessThan6')
  })
  password: string;
}
```

在 `main.ts` 中配置全局验证管道：

```typescript
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { I18nValidationExceptionFilter, I18nValidationPipe } from 'nestjs-i18n';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  // 使用全局验证管道，进行国际化验证
  app.useGlobalPipes(new I18nValidationPipe());
   // 使用全局异常过滤器，处理国际化验证异常
  app.useGlobalFilters(
    new I18nValidationExceptionFilter({
      detailedErrors: false, // 设置是否显示详细错误信息
    }),
  );

  await app.listen(3000);
}

bootstrap();
```

添加验证消息的资源文件：

**i18n/zh/validate.json**：

```json
{
  "usernameNotEmpty": "用户名不能为空",
  "passwordNotEmpty": "密码不能为空",
  "passwordNotLessThan6": "密码不能少于 6 位"
}
```

**i18n/en/validate.json**：

```json
{
  "usernameNotEmpty": "The username cannot be empty",
  "passwordNotEmpty": "Password cannot be empty",
  "passwordNotLessThan6": "The password cannot be less than 6 characters"
}
```

通过上述配置，可以实现根据语言环境返回不同的验证消息：

![](https://cdn.nlark.com/yuque/0/2025/png/21596389/1749475988310-c1c8d218-53f0-4f88-8c64-4499c090d3b6.png)

修改 cookie：

![](https://cdn.nlark.com/yuque/0/2025/png/21596389/1749475998298-667b0615-0b84-4047-a606-d6b61f4a000b.png)

报错信息为英文：

![](https://cdn.nlark.com/yuque/0/2025/png/21596389/1749476005763-f10198ea-4bfc-43f5-9c05-f624fad1be9c.png)

## 动态消息与占位符
有时候我们需要在消息中插入动态内容，nestjs-i18n 支持占位符功能：

**资源文件中使用占位符**：

![](https://cdn.nlark.com/yuque/0/2025/png/21596389/1749476042942-e2cb0ccf-a2c0-4b9e-a133-6786afa63367.png)

```json
{
  "passwordNotLessThan": "密码不能少于 {len} 位"
}
```

**在验证中使用**：

```typescript
@MinLength(66, {
  message: i18nValidationMessage('validate.passwordNotLessThan', {
    args: { len: 66 }
  })
})
password: string;
```

![](https://cdn.nlark.com/yuque/0/2025/png/21596389/1749476107126-9f396fdc-fa17-491f-b07b-7812911424de.png)

**在服务中使用占位符**：

![](https://cdn.nlark.com/yuque/0/2025/png/21596389/1749476142309-57b21442-27f9-4899-bc7f-86c4a4e281c6.png)

```typescript
getHello(): string {
  return this.i18n.t('test.hello', {
    args: {
      name: '云牧',
    },
  });
}
```

![](https://cdn.nlark.com/yuque/0/2025/png/21596389/1749476149606-a90a113f-93fe-4dc2-acdf-0bf5fd1c15ff.png)



## 实战建议
1. **文件组织**：建议按功能模块组织语言文件，比如 `user.json`、`order.json` 等，而不是把所有文本放在一个文件里。
2. **默认语言**：选择一个主要的目标市场语言作为 `fallbackLanguage`，确保即使某些翻译缺失，用户也能看到可理解的内容。
3. **性能考虑**：在生产环境中关闭 `watch` 选项，避免不必要的文件监听开销。
4. **团队协作**：建立清晰的翻译流程，可以考虑使用专门的翻译管理工具。
