## ä¸šåŠ¡æ¨¡å—é—´çš„è°ƒç”¨é—®é¢˜
åœ¨å¼€å‘å¤æ‚åº”ç”¨æ—¶ï¼Œæˆ‘ä»¬ç»å¸¸é‡åˆ°è¿™æ ·çš„åœºæ™¯ï¼šä¸€ä¸ªåŠŸèƒ½å®Œæˆåéœ€è¦è§¦å‘å…¶ä»–ç›¸å…³æ“ä½œï¼Œä½†åˆä¸æƒ³è®©å„ä¸ªæ¨¡å—ä¹‹é—´äº§ç”Ÿç´§å¯†è€¦åˆã€‚

è¿™å°±åƒç°å®ä¸­çš„åŠå…¬å®¤åä½œâ€”â€”å½“é”€å”®éƒ¨é—¨æˆåŠŸç­¾ä¸‹ä¸€ä¸ªå¤§å•æ—¶ï¼Œä¸éœ€è¦é€ä¸ªé€šçŸ¥è´¢åŠ¡ã€ä»“åº“ã€å®¢æœç­‰éƒ¨é—¨ï¼Œåªéœ€è¦åœ¨å…¬å¸ç¾¤é‡Œå‘ä¸ªæ¶ˆæ¯ï¼š"æ–°è®¢å•æ¥äº†ï¼"å„ä¸ªç›¸å…³éƒ¨é—¨çœ‹åˆ°åè‡ªç„¶ä¼šå¤„ç†è‡ªå·±çš„å·¥ä½œã€‚

Nest çš„ `@nestjs/event-emitter` åŒ…æ­£æ˜¯ä¸ºè§£å†³è¿™ç±»é—®é¢˜è€Œç”Ÿçš„ã€‚å®ƒåŸºäºæµè¡Œçš„ eventemitter2 åº“ï¼Œä¸ºæˆ‘ä»¬æä¾›äº†ä¸€å¥—å®Œæ•´çš„äº‹ä»¶é©±åŠ¨è§£å†³æ–¹æ¡ˆã€‚



## äº‹ä»¶é©±åŠ¨é€šä¿¡æ–¹å¼
åˆ›å»ºæ–°é¡¹ç›®ï¼Œå®‰è£…å¿…è¦çš„åŒ…ï¼Œå¯åŠ¨ï¼š 

```bash
nest new event-emitter-test -p pnpm
cd event-emitter-test
pnpm i @nestjs/event-emitter
pnpm start:dev
```

åœ¨ `AppModule` ä¸­å¼•å…¥ `EventEmitterModule`ï¼š 

```typescript
import { Module } from '@nestjs/common';
import { EventEmitterModule } from '@nestjs/event-emitter';
import { AppController } from './app.controller';
import { AppService } from './app.service';

@Module({
  imports: [EventEmitterModule.forRoot()], // å¯åŠ¨äº‹ä»¶ç³»ç»Ÿ
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

åˆ›å»ºä¸¤ä¸ªæ¨¡å—ï¼š

```bash
nest g resource test1
nest g resource test2
```

åœ¨ `Test1Service` ä¸­æ³¨å…¥ `EventEmitter2` å¹¶é€šè¿‡ `this.eventEmitter.emit()` å‘å°„äº‹ä»¶ï¼š

```typescript
import { Injectable } from '@nestjs/common';
import { EventEmitter2 } from '@nestjs/event-emitter';

@Injectable()
export class Test1Service {
  constructor(private eventEmitter: EventEmitter2) {}

  findAll() {
    this.eventEmitter.emit('test1.findAll', {
      data: 'æ¥è‡ª test1 çš„æ•°æ®',
    });
  }
}
```

ä¿®æ”¹ `Test1Controller`ï¼š

```typescript
import { Controller, Get } from '@nestjs/common';
import { Test1Service } from './test1.service';

@Controller('test1')
export class Test1Controller {
  constructor(private readonly test1Service: Test1Service) {}

  @Get()
  triggerFindAllEvent() {
    return this.test1Service.findAll();
  }
}
```

åœ¨ `Test2Service` ä¸­ç›‘å¬äº‹ä»¶å¹¶å¤„ç†ï¼š 

```typescript
import { Injectable } from '@nestjs/common';
import { OnEvent } from '@nestjs/event-emitter';

@Injectable()
export class Test2Service {
  @OnEvent('test1.findAll')
  handleFind(data) {
    console.log('Test2 Service è°ƒç”¨', data);
  }
}
```

  è®¿é—® `localhost:3000/test1` æ¥è°ƒç”¨ Test1 çš„ findAll æ–¹æ³•ï¼š

Test2 ç¡®å®æ”¶åˆ°äº†æ¶ˆæ¯ï¼š

![](https://cdn.nlark.com/yuque/0/2024/png/21596389/1714723301490-3e81bb38-9c63-41eb-9cea-a4676e072db5.png)



## é…ç½® EventEmitterModule
EventEmitterModule æ”¯æŒä¸€äº›é…ç½®é€‰é¡¹ï¼š

```typescript
EventEmitterModule.forRoot({
  wildcard: true,        // å¯ç”¨é€šé…ç¬¦åŒ¹é…ï¼Œå¦‚ 'order.*'
  delimiter: '.',        // äº‹ä»¶ååˆ†éš”ç¬¦
  maxListeners: 20,      // å•ä¸ªäº‹ä»¶æœ€å¤§ç›‘å¬å™¨æ•°é‡
  ignoreErrors: false,   // é»˜è®¤å€¼ã€‚å½“è§¦å‘ç‰¹æ®Šçš„ 'error' äº‹ä»¶ä¸”æ²¡æœ‰ç›‘å¬å™¨å¤„ç†æ—¶ï¼Œæ˜¯å¦æŠ›å‡ºå¼‚å¸¸ï¼›false ä¼šæŠ›å‡ºï¼Œtrue åˆ™ä¸æŠ›å‡ºã€‚
});
```

é€šå¸¸æƒ…å†µä¸‹ï¼Œé»˜è®¤é…ç½®å°±å¤Ÿç”¨äº†ã€‚

é…ç½®åï¼Œå¯ä»¥ä½¿ç”¨é€šé…ç¬¦åŒ¹é…äº‹ä»¶ï¼š

```typescript
findAll() {
  this.eventEmitter.emit('test1.find', { data: 'test1 data1' });
  this.eventEmitter.emit('test1.find2', { data: 'test data2' });
}
```

åœ¨ Test2Service ä¸­ä½¿ç”¨é€šé…ç¬¦ç›‘å¬äº‹ä»¶ï¼š

```typescript
@OnEvent('test1.*')
handleEvents(data: any) {
  console.log('test1 äº‹ä»¶', data);
}
```

è®¿é—® `localhost:3000/test1`ï¼š

![](https://cdn.nlark.com/yuque/0/2024/png/21596389/1719075736974-64247e73-b3b7-4f76-9f45-86f282c4e87b.png)



## ç›‘å¬å™¨é€‰é¡¹è¯¦è§£
`@OnEvent()` è£…é¥°å™¨æ”¯æŒå¤šç§é…ç½®é€‰é¡¹ï¼š

```typescript
@Injectable()
export class AdvancedListenerService {
  // å¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡å…¶ä»–ç›‘å¬å™¨
  @OnEvent('user.registered', { async: true })
  async handleUserRegistration(event: any) {
    await this.sendWelcomeEmail(event.userId);
  }

  // ä¼˜å…ˆæ‰§è¡Œï¼ˆæ·»åŠ åˆ°ç›‘å¬å™¨é˜Ÿåˆ—å¼€å¤´ï¼‰
  @OnEvent('order.cancelled', { prependListener: true })
  handleOrderCancellation(event: any) {
    console.log('ä¼˜å…ˆå¤„ç†è®¢å•å–æ¶ˆ');
  }

  // é”™è¯¯å¤„ç†ç¤ºä¾‹ï¼ˆ@OnEvent æ”¯æŒ suppressErrors é…ç½®æ¥æŠ‘åˆ¶ç›‘å¬å™¨å†…éƒ¨å¼‚å¸¸æŠ›å‡ºï¼‰
  @OnEvent('data.sync', { suppressErrors: true })
  handleDataSync(event: any) {
    try {
      // å¤„ç†åŒæ­¥é€»è¾‘
    } catch (e) {
      // ä½¿ç”¨åº”ç”¨çº§æ—¥å¿—æˆ–é”™è¯¯ä¸ŠæŠ¥è¿›è¡Œå¤„ç†ï¼Œé¿å…å½±å“å…¶ä»–ç›‘å¬å™¨
    }
  }

  private async sendWelcomeEmail(userId: number) { /* å®ç° */ }
}
```



## ğŸŒ° ç”µå•†è®¢å•å¤„ç†
æˆ‘ä»¬çœ‹ä¸€ä¸ªæ›´å®Œæ•´çš„ç”µå•†è®¢å•å¤„ç†ç¤ºä¾‹ï¼š

```typescript
// äº‹ä»¶å®šä¹‰
export class OrderCreatedEvent {
  constructor(
    public orderId: number,
    public customerId: number,
    public items: Array<{ productId: number; quantity: number; price: number }>,
    public totalAmount: number,
  ) {}
}

export class PaymentProcessedEvent {
  constructor(
    public orderId: number,
    public paymentId: string,
    public amount: number,
    public method: string,
  ) {}
}

// è®¢å•æœåŠ¡
@Injectable()
export class OrderService {
  constructor(private eventEmitter: EventEmitter2) {}

  async createOrder(orderData: any): Promise<any> {
    const order = await this.saveOrder(orderData);
    
    // å‘å°„è®¢å•åˆ›å»ºäº‹ä»¶
    this.eventEmitter.emit('order.created', new OrderCreatedEvent(
      order.id,
      order.customerId,
      order.items,
      order.totalAmount
    ));

    return order;
  }

  async processPayment(orderId: number, paymentData: any): Promise<void> {
    const payment = await this.handlePayment(paymentData);
    
    // å‘å°„æ”¯ä»˜å®Œæˆäº‹ä»¶
    this.eventEmitter.emit('payment.processed', new PaymentProcessedEvent(
      orderId,
      payment.id,
      payment.amount,
      payment.method
    ));
  }

  private async saveOrder(data: any) { /* å®ç° */ }
  private async handlePayment(data: any) { /* å®ç° */ }
}

// å¤šä¸ªæœåŠ¡ç›‘å¬åŒä¸€äº‹ä»¶
@Injectable()
export class EmailService {
  @OnEvent('order.created')
  sendOrderConfirmation(event: OrderCreatedEvent) {
    console.log(`å‘é€è®¢å•ç¡®è®¤é‚®ä»¶ï¼Œè®¢å•ï¼š${event.orderId}`);
  }

  @OnEvent('payment.processed')
  sendPaymentReceipt(event: PaymentProcessedEvent) {
    console.log(`å‘é€æ”¯ä»˜å‡­è¯ï¼Œè®¢å•ï¼š${event.orderId}`);
  }
}

@Injectable()
export class InventoryService {
  @OnEvent('order.created', { async: true })
  async reserveInventory(event: OrderCreatedEvent) {
    console.log(`é¢„ç•™åº“å­˜ï¼Œè®¢å•ï¼š${event.orderId}`);
    for (const item of event.items) {
      await this.reserveItem(item.productId, item.quantity);
    }
  }

  private async reserveItem(productId: number, quantity: number) { /* å®ç° */ }
}

@Injectable()
export class LogisticsService {
  @OnEvent('payment.processed', { async: true })
  async arrangeShipping(event: PaymentProcessedEvent) {
    console.log(`å®‰æ’å‘è´§ï¼Œè®¢å•ï¼š${event.orderId}`);
    await this.createShippingOrder(event.orderId);
  }

  private async createShippingOrder(orderId: number) { /* å®ç° */ }
}
```



## **ğŸŒ°**** ç”¨æˆ·æ³¨å†ŒæˆåŠŸåå‘é€æ¬¢è¿é‚®ä»¶**
åˆ›å»ºç”¨æˆ·æ¨¡å—ã€é€šçŸ¥æ¨¡å—å’Œé‚®ä»¶æ¨¡å—ï¼š

```bash
nest g resource user --no-spec
nest g resource notification --no-spec

nest g module email
nest g service email --no-spec
```

å®‰è£… nodemailer åŒ…ï¼š

```bash
pnpm install nodemailer
```

é…ç½® `EmailService`ï¼š

```typescript
import { Injectable } from '@nestjs/common';
import { createTransport, Transporter } from 'nodemailer';

@Injectable()
export class EmailService {
  private transporter: Transporter;

  constructor() {
    this.transporter = createTransport({
      host: 'smtp.qq.com',
      port: 587,
      secure: false,
      auth: {
        user: 'ä½ çš„ç”¨æˆ·å',
        pass: 'ä½ çš„æˆæƒç ',
      },
    });
  }

  async sendMail({
    to,
    subject,
    html,
  }: {
    to: string;
    subject: string;
    html: string;
  }) {
    await this.transporter.sendMail({
      from: {
        name: 'ç³»ç»Ÿé‚®ä»¶',
        address: 'ä½ çš„é‚®ç®±åœ°å€',
      },
      to,
      subject,
      html,
    });
  }
}
```

å°† `EmailModule` å£°æ˜ä¸ºå…¨å±€æ¨¡å—ï¼š

```typescript
import { Global, Module } from '@nestjs/common';
import { EmailService } from './email.service';

// å…¨å±€æ¨¡å—
@Global()
@Module({
  providers: [EmailService],
  exports: [EmailService],
})
export class EmailModule {}
```

åœ¨ `NotificationService` ä¸­ç›‘å¬ç”¨æˆ·æ³¨å†Œäº‹ä»¶å¹¶å‘é€é‚®ä»¶ï¼š

```typescript
import { Injectable } from '@nestjs/common';
import { OnEvent } from '@nestjs/event-emitter';
import { EmailService } from '../email/email.service';

@Injectable()
export class NotificationService {
  constructor(private emailService: EmailService) {}

  @OnEvent('user.register')
  async handleUserRegister(data: { username: string; email: string }) {
    console.log('user.register');
    await this.emailService.sendMail({
      to: data.email,
      subject: `æ¬¢è¿ ${data.username}`,
      html: 'æ¬¢è¿æ–°äºº',
    });
  }
}
```

åœ¨ `CreateUserDto` ä¸­æ·»åŠ å±æ€§ï¼š 

```typescript
export class CreateUserDto {
    username: string;
    email: string;
}
```

6. åœ¨ `UserService` ä¸­å‘é€ç”¨æˆ·æ³¨å†Œäº‹ä»¶ï¼š

```typescript
import { Injectable } from '@nestjs/common';
import { EventEmitter2 } from '@nestjs/event-emitter';
import { CreateUserDto } from './dto/create-user.dto';

@Injectable()
export class UserService {
  constructor(private eventEmitter: EventEmitter2) {}

  create(createUserDto: CreateUserDto) {
    this.eventEmitter.emit('user.register', {
      username: createUserDto.username,
      email: createUserDto.email,
    });
    return 'success';
  }
}
```

ä½¿ç”¨ Postman æµ‹è¯•ï¼š

![](https://cdn.nlark.com/yuque/0/2024/png/21596389/1719077363021-2875e9d9-8035-4660-895c-6089f3026095.png)

æ­¤æ—¶é‚®ç®±å°±èƒ½æ”¶åˆ°é‚®ä»¶å•¦ï¼š

![](https://cdn.nlark.com/yuque/0/2024/png/21596389/1719077436112-9fccb81f-e2e9-4e3b-a990-254ea54f5e82.png)



## æœ€ä½³å®è·µå»ºè®®
+ **äº‹ä»¶å‘½ååˆ«éšæ„**ï¼šå»ºè®®ç”¨ç‚¹åˆ†éš”çš„æ–¹å¼ï¼Œæ¯”å¦‚ `user.created`ã€`order.shipped`ï¼Œè¿™æ ·çœ‹èµ·æ¥æ¸…æ™°ï¼Œç”¨é€šé…ç¬¦ç›‘å¬ä¹Ÿæ–¹ä¾¿ã€‚å°±åƒç»™æ–‡ä»¶å¤¹åˆ†ç±»ä¸€æ ·ï¼Œæœ‰å±‚æ¬¡æ„Ÿ
+ **è€—æ—¶æ“ä½œè®°å¾—åŠ  **`**async: true**`ï¼šæ¯”å¦‚å‘é‚®ä»¶ã€è°ƒç”¨ç¬¬ä¸‰æ–¹ API è¿™äº›ï¼Œå¦‚æœä¸è®¾ç½®å¼‚æ­¥ï¼Œä¼šæŠŠæ•´ä¸ªäº‹ä»¶æµç¨‹å¡ä½ï¼Œå…¶ä»–ç›‘å¬å™¨éƒ½å¾—ç­‰ç€
+ **ç›‘å¬å™¨é‡Œçš„å¼‚å¸¸è¦å¤„ç†å¥½**ï¼šä¸€ä¸ªç›‘å¬å™¨å‡ºé”™äº†ï¼Œåˆ«å½±å“å…¶ä»–çš„ã€‚è¦ä¹ˆç”¨ try-catch åŒ…ä½ï¼Œè¦ä¹ˆåœ¨ `@OnEvent()` ä¸­è®¾ç½® `{ suppressErrors: true }` æŠ‘åˆ¶æŠ›é”™ï¼ˆæ³¨æ„ï¼š`ignoreErrors` ä»…å½±å“æœªè¢«ç›‘å¬çš„ `error` äº‹ä»¶ï¼Œä¸ä¼šå¤„ç†ç›‘å¬å™¨å†…éƒ¨å¼‚å¸¸ï¼‰ã€‚
+ **åˆ«æå¾ªç¯äº‹ä»¶**ï¼šæ¯”å¦‚ A äº‹ä»¶è§¦å‘ B äº‹ä»¶ï¼ŒB äº‹ä»¶åˆè§¦å‘ A äº‹ä»¶ï¼Œè¿™æ ·ä¼šæ— é™å¾ªç¯ä¸‹å»ã€‚è®¾è®¡äº‹ä»¶æµæ—¶è¦æƒ³æ¸…æ¥šï¼Œä¿æŒå•å‘æµåŠ¨
+ **æ³¨å†Œæ—¶æœº**ï¼šåœ¨ OnApplicationBootstrap ç”Ÿå‘½å‘¨æœŸé’©å­ä¸­å‘å°„äº‹ä»¶æ˜¯ä¸€ç§å¸¸è§çš„åšæ³•ï¼Œå› ä¸ºæ­¤æ—¶æ•´ä¸ªåº”ç”¨ç¨‹åºçš„æ¨¡å—å’Œæä¾›è€…ï¼ˆåŒ…æ‹¬äº‹ä»¶ç›‘å¬å™¨ï¼‰éƒ½å·²ç»è¢«å®ä¾‹åŒ–å’Œå¼•å¯¼

