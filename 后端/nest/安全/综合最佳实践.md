## 综合最佳实践：打造健壮的安全策略

### 环境区分配置
不同环境需要不同策略。以下是一个示例配置文件：

```typescript
// config/security.config.ts
export const getSecurityConfig = () => {
  const isProduction = process.env.NODE_ENV === 'production';

  return {
    cors: {
      origin: isProduction ? process.env.ALLOWED_ORIGINS?.split(',') : true,
      credentials: true,
    },
    throttle: {
      ttl: isProduction ? 60 : 10, // 单位为秒，@nestjs/throttler 的 ttl 为秒
      limit: isProduction ? 10 : 100,
    },
  };
};
```

在 `main.ts` 中使用：

```typescript
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { getSecurityConfig } from './config/security.config';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  const config = getSecurityConfig();
  app.enableCors(config.cors);
  await app.listen(3000);
}
bootstrap();
```

### 监控和日志
记录安全事件对排查问题至关重要：

```typescript
import { Injectable, Logger } from '@nestjs/common';

@Injectable()
export class SecurityLogger {
  private readonly logger = new Logger(SecurityLogger.name);

  logThrottleExceeded(ip: string, endpoint: string) {
    this.logger.warn(`Rate limit exceeded for IP ${ip} on ${endpoint}`);
  }

  logCsrfAttempt(ip: string) {
    this.logger.error(`Potential CSRF attack from IP ${ip}`);
  }
}
```

### 渐进式安全策略
- 开发环境：测试所有安全配置，确保功能正常。
- 测试环境：进行压力测试，验证高负载下的表现。
- 生产环境：先用宽松限制，观察后逐步收紧。
- 定期审查：根据日志和监控数据调整策略。

## 总结
CORS、CSRF 防护和速率限制是构建安全 Web 应用的基础。CORS 让前后端分离更顺畅，CSRF 防护阻挡恶意请求，速率限制保护 API 免受滥用。在 NestJS 中，这些功能通过简单配置和第三方库即可实现。

通过区分环境、记录日志和渐进式收紧策略，你可以打造一个既安全又高效的 Web 应用。
