
# AI Prompt: Go 与 MongoDB 实战：从基础 CRUD 到聚合管道

## 核心目标

你是一位经验丰富的 Go 开发者，对 NoSQL 数据库特别是 MongoDB 有深入的理解和实战经验。请撰写一篇关于使用官方 `mongo-go-driver` 与 MongoDB 进行交互的综合性指南。

本文旨在帮助 Go 开发者掌握在项目中有效使用 MongoDB 的全套技能，包括但不限于：优雅地处理 BSON、执行高效的 CRUD 操作、利用索引进行性能优化、释放聚合管道的强大分析能力，以及在需要时使用事务保证数据一致性。

## 内容结构

### 1. 引言：为什么选择 MongoDB for Go？
- **文档模型的优势**：阐述 MongoDB 的 JSON-like 文档模型如何与 Go 的 `struct` 无缝对应，特别适合需要灵活 Schema 和快速迭代的现代应用。
- **`mongo-go-driver` 介绍**：介绍官方驱动的设计哲学——现代、惯用且完全基于 `context.Context`，确保了与 Go 生态系统的良好集成。

### 2. 基础入门：连接与 BSON
- **连接与配置**：演示如何使用 `mongo.Connect` 建立连接，并通过 `options.ClientOptions` 进行详细配置（如设置连接池大小、超时等）。强调使用 `defer client.Disconnect(ctx)` 来确保连接被关闭。
- **Ping 与健康检查**：展示如何使用 `client.Ping` 来验证与数据库的连通性。
- **BSON 与 Go Struct 的映射**：
  - **`bson` 标签**：详细解释 `bson:"..."` struct tag 的用法，包括字段名映射 (`bson:"name"`)、忽略字段 (`bson:"-"`) 和 `omitempty` (`bson:"name,omitempty"`)。
  - **`primitive.ObjectID`**：解释 MongoDB 的 `_id` 字段，并演示如何在 Go struct 中使用 `primitive.ObjectID` 类型来表示它。
  - **`D/M/A/E` 类型**：简要介绍 `bson.D`, `bson.M`, `bson.A`, `bson.E` 这些底层 BSON 类型，并解释何时可能需要直接使用它们来构建复杂的查询或更新。

### 3. 核心 CRUD 操作
针对每种操作，提供清晰的代码示例，并解释其关键选项。

- **插入 (`InsertOne`, `InsertMany`)**
  - 演示如何插入单个和多个文档，并从 `InsertOneResult` 或 `InsertManyResult` 中获取新生成的 `_id`。
- **查询 (`FindOne`, `Find`)**
  - **过滤器 (`bson.D` / `bson.M`)**：展示如何构建过滤器来查询数据，包括使用 `$eq`, `$gt`, `$in` 等操作符。
  - **`FindOne`**：用于查询单个文档，并使用 `Decode()` 方法将其解码到 Go struct 中。强调对 `mongo.ErrNoDocuments` 错误的处理。
  - **`Find`**：用于查询多个文档，返回一个 `mongo.Cursor`。演示如何使用 `for cursor.Next(ctx)` 和 `cursor.Decode()` 来遍历结果集，并强调 `defer cursor.Close(ctx)` 的重要性。
  - **查询选项**：介绍 `options.FindOptions`，演示如何实现排序 (`SetSort`)、分页 (`SetSkip`, `SetLimit`) 和投影 (`SetProjection`)。
- **更新 (`UpdateOne`, `UpdateMany`, `ReplaceOne`)**
  - **更新操作符**：展示如何使用 `$set`, `$inc`, `$push` 等操作符来修改文档的特定字段。
  - **`Upsert` 选项**：解释 `options.UpdateOptions` 中的 `SetUpsert(true)` 如何在文档不存在时执行插入操作。
  - **`UpdateOne` vs `ReplaceOne`**：辨析两者的区别（前者修改字段，后者替换整个文档）。
- **删除 (`DeleteOne`, `DeleteMany`)**
  - 演示如何根据过滤器删除单个或多个文档。

### 4. 性能与优化：索引的力量
- **创建索引**：解释索引对查询性能的决定性作用。演示如何使用 `collection.Indexes().CreateOne()` 或 `CreateMany()` 来为字段创建单键索引或复合索引。
- **索引选项**：介绍如何创建唯一索引 (`SetUnique`)、稀疏索引 (`SetSparse`) 和 TTL 索引 (`SetExpireAfterSeconds`)。

### 5. 数据分析的利器：聚合管道 (Aggregation Pipeline)
- **核心概念**：将聚合管道比作一个数据处理的流水线，每个阶段 (`stage`) 对输入的文档进行处理，并将结果传递给下一个阶段。
- **常用阶段详解与示例**：
  - **`$match`**：过滤文档，相当于 `WHERE` 子句。
  - **`$group`**：按指定字段分组，并进行累加 (`$sum`)、计数 (`$sum: 1`)、求平均 (`$avg`) 等操作。
  - **`$sort`**：排序。
  - **`$limit` / `$skip`**：分页。
  - **`$project`**：重塑文档，选择、重命名字段或计算新字段。
- **代码实现**：提供一个完整的聚合查询示例，例如：计算每个分类下商品的平均价格，并按平均价格降序排序。

### 6. 保证一致性：事务
- **使用场景**：解释何时需要使用事务（当多个操作需要原子性时）。
- **`WithSession` 和 `StartTransaction`**：演示如何使用 `client.UseSession` 和 `session.WithTransaction` 来执行一个事务。在回调函数中执行所有数据库操作，驱动会自动处理 `Commit` 和 `Abort`。
- **注意事项**：强调事务对性能的影响，并指出只有在副本集环境下才能使用事务。

### 7. 总结与最佳实践
- **驱动的最佳实践**：重申 `context` 的传递、客户端的单例模式、正确的错误处理。
- **MongoDB 使用建议**：鼓励开发者根据查询模式设计文档结构，并善用索引和聚合管道。
- **展望**：简要提及 MongoDB 的其他功能，如 Change Streams，激发读者进一步探索。

## 代码要求
- 所有代码片段必须是完整、可运行的，并使用官方 `mongo-go-driver`。
- 代码风格清晰，注释详尽。
- 提供清晰的 Go struct 定义，并使用 `bson` 标签。

## 文章风格
- **结构化与系统性**：从基础到高级，系统地覆盖 MongoDB 在 Go 中的应用。
- **实践导向**：提供大量可以直接用于生产的实用代码示例。
- **深入原理**：不仅展示 API，还解释其背后的设计思想和最佳实践。
