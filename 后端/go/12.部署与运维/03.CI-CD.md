# AI Prompt: 使用 GitHub Actions 为 Go 项目构建 CI/CD 流水线

请你扮演一位资深的 DevOps 专家，尤其擅长使用 GitHub Actions 进行自动化工作流的构建。

我需要你撰写一篇详尽的实战教程，指导 Go 开发者如何利用 GitHub Actions 为他们的项目搭建一个完整、高效的 CI/CD 流水线。文章应从基本概念讲起，逐步构建出一个覆盖代码检查、测试、构建和 Docker 镜像发布全过程的工作流。

**文章目标：**

让读者能够从零开始，为一个典型的 Go Web 项目配置一个生产级别的 GitHub Actions 工作流，实现开发流程的完全自动化。

**核心内容与要求：**

1.  **引言：为什么需要 CI/CD？**
    *   简要介绍 CI (Continuous Integration) 和 CD (Continuous Delivery/Deployment) 的核心思想和价值：自动化、质量保障、快速迭代。
    *   引出 GitHub Actions 作为实现 CI/CD 的强大、便捷且与 GitHub 生态无缝集成的工具。

2.  **GitHub Actions 核心概念快速入门**
    *   **Workflow（工作流）**：`.github/workflows/` 目录下的 YAML 文件。
    *   **Event（事件）**：触发工作流的动作，如 `push`, `pull_request`。
    *   **Job（任务）**：在 Runner 上执行的一组步骤。
    *   **Step（步骤）**：任务中的一个独立操作，可以是运行命令或使用一个 Action。
    *   **Action（动作）**：可复用的代码单元，是构成工作流的基本组件。
    *   **Runner（执行器）**：执行工作流的服务器（如 `ubuntu-latest`）。

3.  **构建第一个 CI 工作流：代码质量保障**
    *   **目标**：在每次向 `main` 分支发起 `push` 或 `pull_request` 时，自动执行代码检查和测试。
    *   **创建工作流文件**：在项目根目录下创建 `.github/workflows/ci.yml`。
    *   **编写 `ci.yml`**：提供一个完整的工作流 YAML 文件，并逐段解释。

        ```yaml
        name: Go CI

        on:
          push:
            branches: [ main ]
          pull_request:
            branches: [ main ]

        jobs:
          test:
            name: Test and Lint
            runs-on: ubuntu-latest

            steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                go-version: '1.21'

            - name: Cache Go modules
              uses: actions/cache@v4
              with:
                path: ~/go/pkg/mod
                key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
                restore-keys: |
                  ${{ runner.os }}-go-

            - name: Run linter (golangci-lint)
              uses: golangci/golangci-lint-action@v4
              with:
                version: v1.57

            - name: Run tests
              run: go test -v -race ./...
        ```
    *   **关键步骤详解**：
        *   `on`: 解释如何配置触发事件。
        *   `jobs.test.steps`:
            *   `actions/checkout@v4`: 拉取代码。
            *   `actions/setup-go@v5`: 安装指定版本的 Go 环境。
            *   `actions/cache@v4`: **重点讲解**如何缓存 Go 模块，以加快后续工作流的执行速度。解释 `key` 和 `restore-keys` 的作用。
            *   `golangci/golangci-lint-action@v4`: 介绍如何集成 `golangci-lint` 来进行静态代码分析。
            *   `go test -v -race ./...`: 运行测试并开启竞争检测。

4.  **构建 CD 工作流：构建与发布 Docker 镜像**
    *   **目标**：当代码成功合并到 `main` 分支后，自动构建 Docker 镜像并推送到 Docker Hub 或 GitHub Container Registry (GHCR)。
    *   **创建 `release.yml`**：在 `.github/workflows/` 目录下创建新文件。
    *   **编写 `release.yml`**：
        ```yaml
        name: Go Release

        on:
          push:
            tags:
              - 'v*.*.*' # 仅在创建新的版本标签时触发

        jobs:
          build-and-push:
            name: Build and Push Docker Image
            runs-on: ubuntu-latest

            steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to Docker Hub
              uses: docker/login-action@v3
              with:
                username: ${{ secrets.DOCKERHUB_USERNAME }}
                password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Extract metadata (tags, labels) for Docker
              id: meta
              uses: docker/metadata-action@v5
              with:
                images: your-dockerhub-username/your-app

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                context: .
                push: true
                tags: ${{ steps.meta.outputs.tags }}
                labels: ${{ steps.meta.outputs.labels }}
        ```
    *   **关键步骤详解**：
        *   `on.push.tags`: 解释为什么 CD 流程通常绑定在 `git tag` 上，这代表一个确定的版本发布。
        *   **Docker Actions**: 介绍 `docker/setup-qemu-action`, `docker/setup-buildx-action`, `docker/login-action`, `docker/metadata-action`, `docker/build-push-action` 这一套官方 Action 组合的用途。
        *   **Secrets 管理**：指导用户如何在 GitHub 仓库的 `Settings -> Secrets and variables -> Actions` 中配置 `DOCKERHUB_USERNAME` 和 `DOCKERHUB_TOKEN` 等敏感信息。
        *   `docker/metadata-action@v5`: **重点讲解**这个 Action 的强大之处，它可以自动根据 Git 标签、分支、Commit SHA 等信息生成合适的 Docker 镜像标签（如 `v1.2.3`, `latest`）。

5.  **整合与最佳实践**
    *   讨论如何将 CI 和 CD 流程串联起来（例如，通过 `needs` 关键字让 `release` job 依赖 `test` job）。
    *   提供一个完整的、结合了 CI 和 CD 的 `main.yml` 示例。
    *   强调在 `Dockerfile` 中使用多阶段构建的重要性，以确保 CI/CD 流水线构建出的镜像是经过优化的。

**总结：**

回顾使用 GitHub Actions 为 Go 项目实现自动化的完整流程。鼓励读者将这套实践应用到自己的项目中，从而解放生产力，专注于代码本身。

