
# Master Prompt: 像构建 SaaS 订阅系统一样管理 AI 授权与配额

## 1. 核心目标 (Core Goal)

你是一位资深的 SaaS 产品架构师，你的任务是为团队撰写一份技术设计文档，指导他们如何为一项新的 AI 服务构建一套健壮、可扩展的“订阅、授权与计费系统”。这份文档需要将复杂的安全和资源管理问题，类比为开发者已经熟知的 SaaS 业务逻辑。

**核心类比**：
- **你的 AI 服务**: 一个待上线的“**SaaS 产品**”。
- **API 调用**: 用户对产品“**功能的使用**”。
- **认证 (Authentication)**: “**用户登录**”——验证用户身份，确认其是否为有效订阅者。
- **API Key / JWT**: 用户的“**访问令牌 (Access Token)**”，证明其已登录且订阅有效。
- **授权 (Authorization)**: “**套餐权限检查**”。根据用户的订阅套餐（`Free`, `Pro`, `Enterprise`）决定他能使用哪些高级功能。
- **配额 (Quota)**: “**套餐用量限制**”。`Pro` 套餐每月可调用 10,000 次，`Enterprise` 套餐无限量。这是计费的核心。
- **速率限制 (Rate Limiting)**: “**API 公平使用策略**”，防止某个用户短时滥用，影响其他用户的体验。
- **多租户 (Multi-tenancy)**: 支持“**团队版/企业版**”，允许多个用户在一个“组织”下共享订阅和用量。

本文的目标是提供一份清晰、可落地的工程蓝图，帮助开发者像构建一个真正的 SaaS 产品一样，思考和实现 AI 服务的安全与商业化基础。

## 2. 文章结构 (Article Structure)

**I. 标题：你的 AI 服务值多少钱？从零构建 SaaS 级的订阅与计费系统**

**II. 引言：从“免费玩具”到“付费产品”**
   - 痛点：当 AI 服务需要商业化或对内部多部门提供时，如何确保安全、公平地分配资源，并为未来的收费做好准备？
   - 解决方案：从第一天起，就用构建 SaaS 产品的思路来设计你的授权和配额体系。

**III. 第一步：“用户系统”——认证机制 (Authentication)**
   - **“登录凭证”的类型**：
     - **API Key**: 适用于服务端到服务端集成的“系统账户密码”，简单高效。
     - **JWT**: 适用于前端用户的“会话 Cookie”，包含用户 ID、套餐等信息，无状态易于横向扩展。
   - **工程实现：`ApiKeyGuard` (Code Snippet)**
     - 演示一个 NestJS Guard 如何从请求头解析凭证，并查询数据库验证其有效性。
     - 讨论密钥的安全存储（哈希处理）、轮换和吊销机制。

**IV. 第二步：“付费墙”——基于角色的授权 (Authorization)**
   - **定义“订阅套餐” (RBAC - Role-Based Access Control)**
     - **角色 (Roles)**: `free_tier`, `pro_tier`, `enterprise_tier`。
     - **权限 (Permissions)**: `can_use_gpt4o`, `can_access_batch_api`。
     - **实现 (Code Snippet)**: 演示如何创建一个 `@Roles('pro_tier')` 装饰器，轻松保护需要付费的 API 路由。
   - **“企业版”的设计 (多租户)**
     - 在 JWT 或 API Key 信息中绑定 `organizationId`。
     - 确保所有数据库查询和资源访问，都基于这个 `organizationId` 进行隔离，防止数据泄露。

**V. 第三步：“计费引擎”——配额与速率限制**
   - **“套餐用量”的设计 (Quota Management)**
     - **模型**：按月/按天限制“API 调用次数”或“Token 总消耗量”。
     - **实现 (Code Snippet)**: 提供一个 `QuotaInterceptor` 示例。它在每次请求成功后，原子化地更新 Redis 中的已用额度 (`INCRBY`)，并检查是否超额。
     ```typescript
     // In QuotaInterceptor.ts
     const used = await redis.incrby(`quota:${userId}:tokens`, consumedTokens);
     if (used > monthlyQuota) {
       throw new QuotaExceededError();
     }
     ```
   - **“公平使用”的保障 (Rate Limiting)**
     - **策略**：区分“按用户ID”限制和“按IP”限制，应对不同滥用场景。
     - **工具**：`rate-limiter-flexible` 提供了丰富的策略（如滑动窗口），比简单的固定窗口更公平。

**VI. 安全最佳实践：保护你的“商业机密”**
   - **后端代理原则**：再次强调，前端（浏览器/App）绝不能直接持有任何上游 AI Provider 的密钥。所有请求必须经过你的后端，由后端使用你自己的“订阅系统”进行认证授权。
   - **凭证的生命周期管理**：讨论如何为 JWT 设置合理的过期时间，并实现 Refresh Token 机制，提升用户体验和安全性。

**VII. 审计与风控：保护你的“资产安全”**
   - **“交易记录” (Audit Logs)**：记录每一次 API 调用的关键信息：`userId`, `organizationId`, `endpoint`, `cost`, `quotaUsed`。
   - **“风险告警” (Alerts)**：设置告警规则，如“某用户配额在月初第一天就耗尽”、“大量无效 API Key 的尝试”等，及时发现潜在的账户盗用或滥用行为。

## 3. 质量与风格核对清单 (Quality & Style Checklist)

- [ ] **SaaS 类比**：“订阅系统”的类比是否清晰、一致，并能有效指导技术选型和架构设计？
- [ ] **商业导向**：是否将安全和资源管理问题，转化为设计“订阅套餐”和“计费规则”的商业决策？
- [ ] **代码健壮性**：提供的 Guard 和 Interceptor 代码是否考虑了并发安全（如 Redis 原子操作）和错误处理？
- [ ] **多租户设计**：是否清晰地解释了如何在身份验证和数据访问层面实现租户隔离？
- [ ] **可操作性**：审计和告警部分是否提供了具体、可落地的建议，帮助保护服务的商业利益？
