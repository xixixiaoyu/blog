# Python 数据库操作

## 最佳提示词

```
请详细介绍 Python 的数据库操作，包括以下内容：

1. 数据库基础：
   - 关系型数据库概念
   - SQL 语言基础
   - 数据库连接原理
   - 事务与并发控制

2. SQLite 操作：
   - sqlite3 模块使用
   - 数据库创建与连接
   - 表的创建与管理
   - 增删改查操作

3. MySQL 操作：
   - mysql-connector-python
   - PyMySQL 驱动
   - 连接池管理
   - 存储过程调用

4. PostgreSQL 操作：
   - psycopg2 驱动
   - 高级数据类型
   - 数组与JSON操作
   - 全文搜索

5. ORM 框架：
   - SQLAlchemy 基础
   - 模型定义与关系
   - 查询构建器
   - 数据迁移

6. NoSQL 数据库：
   - MongoDB 操作
   - Redis 缓存
   - 连接与配置
   - 数据序列化

请为每个数据库提供详细的代码示例，包括实际应用场景和最佳实践。
```

## 学习要点

- 理解数据库的基本概念和 SQL 语言
- 掌握不同数据库的连接和操作方法
- 学会使用 ORM 框架进行数据库操作
- 了解 NoSQL 数据库的特点和使用场景
- 掌握数据库事务和性能优化
- 学会处理数据库连接和异常

## 实践练习

1. 实现 SQLite 数据库操作
2. 连接 MySQL/PostgreSQL 数据库
3. 使用 SQLAlchemy 构建 ORM 模型
4. 操作 MongoDB 和 Redis
5. 实现数据库连接池和事务管理

## 代码示例模板

```python
import sqlite3
import mysql.connector
import psycopg2
from sqlalchemy import create_engine, Column, Integer, String, Float, ForeignKey, DateTime
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker, relationship
from pymongo import MongoClient
import redis
import json
from datetime import datetime

# SQLite 操作示例
class SQLiteExample:
    def __init__(self, db_path='example.db'):
        self.db_path = db_path
        self.connection = None
    
    def connect(self):
        """连接数据库"""
        self.connection = sqlite3.connect(self.db_path)
        self.connection.row_factory = sqlite3.Row  # 返回字典形式
    
    def create_tables(self):
        """创建表"""
        cursor = self.connection.cursor()
        
        # 用户表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS users (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                username TEXT UNIQUE NOT NULL,
                email TEXT UNIQUE NOT NULL,
                age INTEGER,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # 订单表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS orders (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                product_name TEXT NOT NULL,
                price REAL NOT NULL,
                quantity INTEGER NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users (id)
            )
        ''')
        
        self.connection.commit()
    
    def insert_user(self, username, email, age):
        """插入用户"""
        cursor = self.connection.cursor()
        cursor.execute(
            'INSERT INTO users (username, email, age) VALUES (?, ?, ?)',
            (username, email, age)
        )
        self.connection.commit()
        return cursor.lastrowid
    
    def insert_order(self, user_id, product_name, price, quantity):
        """插入订单"""
        cursor = self.connection.cursor()
        cursor.execute(
            'INSERT INTO orders (user_id, product_name, price, quantity) VALUES (?, ?, ?, ?)',
            (user_id, product_name, price, quantity)
        )
        self.connection.commit()
        return cursor.lastrowid
    
    def query_users(self):
        """查询用户"""
        cursor = self.connection.cursor()
        cursor.execute('SELECT * FROM users')
        return cursor.fetchall()
    
    def query_user_orders(self, user_id):
        """查询用户订单"""
        cursor = self.connection.cursor()
        cursor.execute('''
            SELECT o.*, u.username 
            FROM orders o 
            JOIN users u ON o.user_id = u.id 
            WHERE o.user_id = ?
        ''', (user_id,))
        return cursor.fetchall()
    
    def update_user(self, user_id, age):
        """更新用户信息"""
        cursor = self.connection.cursor()
        cursor.execute('UPDATE users SET age = ? WHERE id = ?', (age, user_id))
        self.connection.commit()
        return cursor.rowcount
    
    def delete_user(self, user_id):
        """删除用户"""
        cursor = self.connection.cursor()
        cursor.execute('DELETE FROM users WHERE id = ?', (user_id,))
        self.connection.commit()
        return cursor.rowcount
    
    def close(self):
        """关闭连接"""
        if self.connection:
            self.connection.close()

# MySQL 操作示例
class MySQLExample:
    def __init__(self, host='localhost', user='root', password='', database='test'):
        self.config = {
            'host': host,
            'user': user,
            'password': password,
            'database': database,
            'charset': 'utf8mb4'
        }
        self.connection = None
    
    def connect(self):
        """连接数据库"""
        try:
            self.connection = mysql.connector.connect(**self.config)
            print("MySQL 连接成功")
        except mysql.connector.Error as e:
            print(f"MySQL 连接错误: {e}")
    
    def execute_query(self, query, params=None):
        """执行查询"""
        cursor = self.connection.cursor(dictionary=True)
        try:
            cursor.execute(query, params or ())
            if query.strip().upper().startswith('SELECT'):
                return cursor.fetchall()
            else:
                self.connection.commit()
                return cursor.rowcount
        except mysql.connector.Error as e:
            print(f"查询错误: {e}")
            self.connection.rollback()
            return None
        finally:
            cursor.close()
    
    def insert_with_transaction(self, users_data):
        """事务插入"""
        try:
            cursor = self.connection.cursor()
            
            # 开始事务
            self.connection.start_transaction()
            
            for user in users_data:
                cursor.execute(
                    'INSERT INTO users (username, email, age) VALUES (%s, %s, %s)',
                    (user['username'], user['email'], user['age'])
                )
            
            # 提交事务
            self.connection.commit()
            print(f"成功插入 {len(users_data)} 条记录")
            
        except mysql.connector.Error as e:
            # 回滚事务
            self.connection.rollback()
            print(f"事务错误: {e}")
        finally:
            cursor.close()
    
    def close(self):
        """关闭连接"""
        if self.connection:
            self.connection.close()

# PostgreSQL 操作示例
class PostgreSQLExample:
    def __init__(self, host='localhost', database='test', user='postgres', password=''):
        self.config = {
            'host': host,
            'database': database,
            'user': user,
            'password': password
        }
        self.connection = None
    
    def connect(self):
        """连接数据库"""
        try:
            self.connection = psycopg2.connect(**self.config)
            print("PostgreSQL 连接成功")
        except psycopg2.Error as e:
            print(f"PostgreSQL 连接错误: {e}")
    
    def execute_query(self, query, params=None):
        """执行查询"""
        with self.connection.cursor() as cursor:
            try:
                cursor.execute(query, params or ())
                if query.strip().upper().startswith('SELECT'):
                    columns = [desc[0] for desc in cursor.description]
                    return [dict(zip(columns, row)) for row in cursor.fetchall()]
                else:
                    self.connection.commit()
                    return cursor.rowcount
            except psycopg2.Error as e:
                print(f"查询错误: {e}")
                self.connection.rollback()
                return None
    
    def use_json(self):
        """使用 JSON 数据类型"""
        query = '''
            CREATE TABLE IF NOT EXISTS products (
                id SERIAL PRIMARY KEY,
                name VARCHAR(100) NOT NULL,
                attributes JSONB,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        '''
        self.execute_query(query)
        
        # 插入 JSON 数据
        product_data = {
            'color': 'red',
            'size': ['M', 'L', 'XL'],
            'price': 29.99,
            'tags': ['clothing', 'sale']
        }
        
        query = '''
            INSERT INTO products (name, attributes) 
            VALUES (%s, %s)
        '''
        self.execute_query(query, ('T-Shirt', json.dumps(product_data)))
        
        # 查询 JSON 数据
        query = '''
            SELECT name, attributes->>'color' as color, attributes->'size' as sizes
            FROM products 
            WHERE attributes->>'color' = %s
        '''
        return self.execute_query(query, ('red',))
    
    def close(self):
        """关闭连接"""
        if self.connection:
            self.connection.close()

# SQLAlchemy ORM 示例
Base = declarative_base()

class User(Base):
    __tablename__ = 'users'
    
    id = Column(Integer, primary_key=True)
    username = Column(String(50), unique=True, nullable=False)
    email = Column(String(100), unique=True, nullable=False)
    age = Column(Integer)
    created_at = Column(DateTime, default=datetime.utcnow)
    
    # 关系
    orders = relationship("Order", back_populates="user")
    
    def __repr__(self):
        return f"<User(username='{self.username}', email='{self.email}')>"

class Order(Base):
    __tablename__ = 'orders'
    
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey('users.id'), nullable=False)
    product_name = Column(String(100), nullable=False)
    price = Column(Float, nullable=False)
    quantity = Column(Integer, nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    
    # 关系
    user = relationship("User", back_populates="orders")
    
    def __repr__(self):
        return f"<Order(product='{self.product_name}', price={self.price})>"

class SQLAlchemyExample:
    def __init__(self, database_url='sqlite:///orm_example.db'):
        self.engine = create_engine(database_url)
        self.Session = sessionmaker(bind=self.engine)
    
    def create_tables(self):
        """创建表"""
        Base.metadata.create_all(self.engine)
    
    def add_user_with_orders(self, username, email, age, orders_data):
        """添加用户和订单"""
        session = self.Session()
        try:
            # 创建用户
            user = User(username=username, email=email, age=age)
            
            # 添加订单
            for order_data in orders_data:
                order = Order(
                    product_name=order_data['product_name'],
                    price=order_data['price'],
                    quantity=order_data['quantity']
                )
                user.orders.append(order)
            
            session.add(user)
            session.commit()
            return user.id
            
        except Exception as e:
            session.rollback()
            print(f"错误: {e}")
            return None
        finally:
            session.close()
    
    def query_users_with_orders(self):
        """查询用户及其订单"""
        session = self.Session()
        try:
            users = session.query(User).options(
                session.query(User).joinedload(User.orders)
            ).all()
            
            result = []
            for user in users:
                user_data = {
                    'id': user.id,
                    'username': user.username,
                    'email': user.email,
                    'orders': [
                        {
                            'product_name': order.product_name,
                            'price': order.price,
                            'quantity': order.quantity
                        }
                        for order in user.orders
                    ]
                }
                result.append(user_data)
            
            return result
            
        finally:
            session.close()
    
    def complex_query(self):
        """复杂查询示例"""
        session = self.Session()
        try:
            # 统计每个用户的订单数量和总金额
            from sqlalchemy import func
            
            result = session.query(
                User.username,
                func.count(Order.id).label('order_count'),
                func.sum(Order.price * Order.quantity).label('total_amount')
            ).join(Order).group_by(User.id).all()
            
            return [
                {
                    'username': row.username,
                    'order_count': row.order_count,
                    'total_amount': float(row.total_amount) if row.total_amount else 0
                }
                for row in result
            ]
            
        finally:
            session.close()

# MongoDB 操作示例
class MongoDBExample:
    def __init__(self, host='localhost', port=27017, database='test'):
        self.client = MongoClient(host, port)
        self.db = self.client[database]
    
    def insert_document(self, collection_name, document):
        """插入文档"""
        collection = self.db[collection_name]
        result = collection.insert_one(document)
        return result.inserted_id
    
    def insert_documents(self, collection_name, documents):
        """插入多个文档"""
        collection = self.db[collection_name]
        result = collection.insert_many(documents)
        return result.inserted_ids
    
    def find_documents(self, collection_name, query=None, projection=None):
        """查找文档"""
        collection = self.db[collection_name]
        return list(collection.find(query or {}, projection))
    
    def update_document(self, collection_name, query, update):
        """更新文档"""
        collection = self.db[collection_name]
        result = collection.update_many(query, {'$set': update})
        return result.modified_count
    
    def delete_document(self, collection_name, query):
        """删除文档"""
        collection = self.db[collection_name]
        result = collection.delete_many(query)
        return result.deleted_count
    
    def aggregate_pipeline(self, collection_name, pipeline):
        """聚合查询"""
        collection = self.db[collection_name]
        return list(collection.aggregate(pipeline))
    
    def close(self):
        """关闭连接"""
        self.client.close()

# Redis 操作示例
class RedisExample:
    def __init__(self, host='localhost', port=6379, db=0):
        self.redis_client = redis.Redis(host=host, port=port, db=db, decode_responses=True)
    
    def string_operations(self):
        """字符串操作"""
        # 设置值
        self.redis_client.set('name', 'Alice')
        self.redis_client.set('age', 25)
        
        # 获取值
        name = self.redis_client.get('name')
        age = self.redis_client.get('age')
        
        # 设置过期时间
        self.redis_client.setex('session', 3600, 'user_session_data')
        
        return {'name': name, 'age': age}
    
    def hash_operations(self):
        """哈希操作"""
        # 设置哈希字段
        self.redis_client.hset('user:1', 'username', 'alice')
        self.redis_client.hset('user:1', 'email', 'alice@example.com')
        self.redis_client.hset('user:1', 'age', 25)
        
        # 获取哈希字段
        user_data = self.redis_client.hgetall('user:1')
        
        # 获取单个字段
        username = self.redis_client.hget('user:1', 'username')
        
        return {'user_data': user_data, 'username': username}
    
    def list_operations(self):
        """列表操作"""
        # 添加元素到列表
        self.redis_client.lpush('tasks', 'task1', 'task2', 'task3')
        
        # 获取列表元素
        tasks = self.redis_client.lrange('tasks', 0, -1)
        
        # 弹出元素
        task = self.redis_client.rpop('tasks')
        
        return {'tasks': tasks, 'popped_task': task}
    
    def set_operations(self):
        """集合操作"""
        # 添加元素到集合
        self.redis_client.sadd('tags', 'python', 'web', 'database')
        self.redis_client.sadd('additional_tags', 'python', 'api')
        
        # 集合运算
        intersection = self.redis_client.sinter('tags', 'additional_tags')
        union = self.redis_client.sunion('tags', 'additional_tags')
        
        return {'intersection': list(intersection), 'union': list(union)}
    
    def cache_example(self, key, data, ttl=3600):
        """缓存示例"""
        # 序列化数据
        serialized_data = json.dumps(data)
        
        # 存储到缓存
        self.redis_client.setex(key, ttl, serialized_data)
    
    def get_cached_data(self, key):
        """获取缓存数据"""
        cached_data = self.redis_client.get(key)
        if cached_data:
            return json.loads(cached_data)
        return None

# 使用示例
def main():
    # SQLite 示例
    sqlite = SQLiteExample()
    sqlite.connect()
    sqlite.create_tables()
    
    user_id = sqlite.insert_user('alice', 'alice@example.com', 25)
    sqlite.insert_order(user_id, 'Laptop', 999.99, 1)
    
    users = sqlite.query_users()
    orders = sqlite.query_user_orders(user_id)
    
    print(f"SQLite 用户: {users}")
    print(f"SQLite 订单: {orders}")
    
    sqlite.close()
    
    # SQLAlchemy 示例
    sqlalchemy = SQLAlchemyExample()
    sqlalchemy.create_tables()
    
    user_id = sqlalchemy.add_user_with_orders(
        'bob', 'bob@example.com', 30,
        [
            {'product_name': 'Mouse', 'price': 29.99, 'quantity': 2},
            {'product_name': 'Keyboard', 'price': 79.99, 'quantity': 1}
        ]
    )
    
    users_with_orders = sqlalchemy.query_users_with_orders()
    complex_result = sqlalchemy.complex_query()
    
    print(f"ORM 用户: {users_with_orders}")
    print(f"复杂查询: {complex_result}")
    
    # MongoDB 示例
    mongo = MongoDBExample()
    
    # 插入文档
    user_doc = {
        'username': 'charlie',
        'email': 'charlie@example.com',
        'age': 35,
        'interests': ['programming', 'music', 'travel']
    }
    mongo.insert_document('users', user_doc)
    
    # 查询文档
    users = mongo.find_documents('users', {'age': {'$gte': 30}})
    print(f"MongoDB 用户: {users}")
    
    # Redis 示例
    redis = RedisExample()
    
    # 字符串操作
    string_result = redis.string_operations()
    print(f"Redis 字符串: {string_result}")
    
    # 哈希操作
    hash_result = redis.hash_operations()
    print(f"Redis 哈希: {hash_result}")
    
    # 缓存示例
    cache_data = {'user_id': 1, 'username': 'alice', 'last_login': '2023-05-15'}
    redis.cache_example('user_session_1', cache_data)
    
    cached_data = redis.get_cached_data('user_session_1')
    print(f"缓存数据: {cached_data}")

if __name__ == "__main__":
    main()
```

## 扩展资源

- [sqlite3 模块文档](https://docs.python.org/3/library/sqlite3.html)
- [mysql-connector-python 文档](https://dev.mysql.com/doc/connector-python/en/)
- [psycopg2 文档](http://initd.org/psycopg/docs/)
- [SQLAlchemy 文档](https://docs.sqlalchemy.org/)
- [PyMongo 文档](https://pymongo.readthedocs.io/)
- [redis-py 文档](https://redis-py.readthedocs.io/)