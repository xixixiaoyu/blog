# Python 错误处理

## 最佳提示词

```
请详细介绍 Python 的错误处理机制，包括以下内容：

1. 异常基础：
   - 异常的概念与类型
   - 常见内置异常类
   - 异常的层次结构
   - 异常的传播机制
   - 异常处理的重要性

2. try-except 语句：
   - 基本语法结构
   - 捕获特定异常类型
   - 多个 except 子句
   - 捕获多种异常类型
   - 异常对象的使用

3. 高级异常处理：
   - try-except-else-finally 结构
   - finally 子句的执行时机
   - 嵌套异常处理
   - 异常链
   - raise 语句的使用

4. 自定义异常：
   - 创建自定义异常类
   - 异常类的最佳实践
   - 异常信息的传递
   - 业务异常的设计

5. 异常处理的最佳实践：
   - 何时捕获异常
   - 何时抛出异常
   - 异常处理的粒度
   - 异常处理的性能考虑
   - 日志记录与异常处理

6. 调试技巧：
   - 使用 traceback 模块
   - 异常信息的格式化
   - 调试工具的使用
   - 异常处理的单元测试

请为每个概念提供详细的代码示例，包括实际应用场景和常见错误。解释异常处理的执行流程和性能影响。
```

## 学习要点

- 理解异常的概念和 Python 异常体系
- 掌握 try-except 语句的各种用法
- 学会使用 else 和 finally 子句
- 理解异常的传播机制
- 学会创建和使用自定义异常
- 掌握异常处理的最佳实践
- 了解异常处理对性能的影响
- 学会使用调试工具处理异常
- 理解异常处理与程序健壮性的关系

## 实践练习

1. 编写可能引发不同类型异常的代码
2. 使用 try-except 捕获和处理这些异常
3. 练习使用 else 和 finally 子句
4. 创建自定义异常类并在程序中使用
5. 实现一个包含异常链的例子
6. 使用 traceback 模块获取详细的异常信息
7. 为异常处理编写单元测试
8. 分析现有代码中的异常处理并提出改进建议

## 代码示例模板

```python
# 基本异常处理
try:
    num = int(input("请输入一个数字: "))
    result = 10 / num
    print(f"结果是: {result}")
except ValueError:
    print("输入的不是有效数字")
except ZeroDivisionError:
    print("不能除以零")
except Exception as e:
    print(f"发生未知错误: {e}")

# try-except-else-finally 结构
def divide_numbers(a, b):
    """除法运算，包含完整的异常处理"""
    try:
        result = a / b
    except ZeroDivisionError:
        print("错误：除数不能为零")
        return None
    except TypeError:
        print("错误：参数必须是数字")
        return None
    else:
        print("除法运算成功")
        return result
    finally:
        print("除法运算结束")

# 自定义异常
class CustomError(Exception):
    """自定义异常类"""
    def __init__(self, message, error_code=None):
        super().__init__(message)
        self.error_code = error_code
    
    def __str__(self):
        if self.error_code:
            return f"错误代码 {self.error_code}: {super().__str__()}"
        return super().__str__()

def validate_age(age):
    """验证年龄"""
    if not isinstance(age, int):
        raise TypeError("年龄必须是整数")
    if age < 0:
        raise CustomError("年龄不能为负数", error_code=1001)
    if age > 150:
        raise CustomError("年龄超出合理范围", error_code=1002)
    return True

# 异常链
def process_data(data):
    """处理数据，演示异常链"""
    try:
        # 假设这里可能引发异常
        result = int(data)
        return result * 2
    except ValueError as e:
        # 捕获原异常并抛出新异常，保留原异常信息
        raise ValueError(f"数据处理失败: {e}") from e

# 使用 traceback 模块
import traceback

def handle_exception():
    """演示如何获取详细的异常信息"""
    try:
        # 故意引发异常
        result = 1 / 0
    except Exception:
        # 获取异常信息
        exc_type, exc_value, exc_traceback = sys.exc_info()
        print("异常类型:", exc_type)
        print("异常值:", exc_value)
        print("异常追踪:")
        traceback.print_exc()

# 上下文管理器中的异常处理
class FileManager:
    """文件管理器，演示上下文管理器中的异常处理"""
    def __init__(self, filename, mode):
        self.filename = filename
        self.mode = mode
        self.file = None
    
    def __enter__(self):
        try:
            self.file = open(self.filename, self.mode)
            return self.file
        except IOError as e:
            print(f"无法打开文件 {self.filename}: {e}")
            raise
    
    def __exit__(self, exc_type, exc_val, exc_tb):
        if self.file:
            self.file.close()
        if exc_type is not None:
            print(f"文件操作发生异常: {exc_val}")
        return True  # 抑制异常
```

## 扩展资源

- [Python 异常处理文档](https://docs.python.org/3/tutorial/errors.html)
- [Python 内置异常类型](https://docs.python.org/3/library/exceptions.html)
- [traceback 模块文档](https://docs.python.org/3/library/traceback.html)
- [Python 调试技巧](https://docs.python.org/3/library/pdb.html)