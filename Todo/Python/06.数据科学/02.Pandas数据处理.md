# Pandas 数据处理

## 最佳提示词

```
请详细介绍 Pandas 数据处理，包括以下内容：

1. Pandas 基础：
   - Pandas 安装与导入
   - Series 对象
   - DataFrame 对象
   - 数据类型与属性

2. 数据导入导出：
   - CSV 文件操作
   - Excel 文件操作
   - JSON 数据处理
   - 数据库连接

3. 数据选择与过滤：
   - 索引与切片
   - 条件过滤
   - 查询方法
   - 多级索引

4. 数据清洗：
   - 缺失值处理
   - 重复值处理
   - 数据类型转换
   - 异常值检测

5. 数据变换：
   - 数据排序
   - 分组聚合
   - 数据合并
   - 数据透视表

6. 数据可视化：
   - 基础绘图
   - 统计图表
   - 时间序列可视化
   - 高级可视化

请为每个功能提供详细的代码示例，包括实际应用场景和最佳实践。
```

## 学习要点

- 掌握 Pandas 的核心数据结构
- 学会数据的导入导出操作
- 理解数据选择和过滤方法
- 掌握数据清洗和变换技巧
- 学会使用 Pandas 进行数据分析
- 了解数据可视化的基本方法

## 实践练习

1. 导入不同格式的数据文件
2. 进行数据清洗和预处理
3. 实现复杂的数据分析任务
4. 创建数据可视化图表
5. 处理时间序列数据

## 代码示例模板

```python
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from datetime import datetime, timedelta
import warnings
warnings.filterwarnings('ignore')

# Pandas 基础操作
def pandas_basics():
    """Pandas 基础操作示例"""
    
    # Series 创建
    s = pd.Series([1, 3, 5, np.nan, 6, 8])
    print("Series:")
    print(s)
    
    # DataFrame 创建
    df = pd.DataFrame({
        'A': [1, 2, 3, 4],
        'B': pd.Timestamp('20230101'),
        'C': pd.Series(1, index=list(range(4)), dtype='float32'),
        'D': np.array([3] * 4, dtype='int32'),
        'E': pd.Categorical(['test', 'train', 'test', 'train']),
        'F': 'foo'
    })
    print("\nDataFrame:")
    print(df)
    
    # 查看数据信息
    print("\n数据信息:")
    print(df.info())
    print("\n数据描述:")
    print(df.describe())
    print("\n数据形状:", df.shape)
    print("\n数据类型:", df.dtypes)

# 数据导入导出
def data_import_export():
    """数据导入导出示例"""
    
    # 创建示例数据
    data = {
        'name': ['Alice', 'Bob', 'Charlie', 'David', 'Eve'],
        'age': [25, 30, 35, 28, 32],
        'city': ['New York', 'London', 'Paris', 'Tokyo', 'Sydney'],
        'salary': [50000, 60000, 70000, 55000, 65000]
    }
    df = pd.DataFrame(data)
    
    # 导出为 CSV
    df.to_csv('employees.csv', index=False)
    print("数据已导出为 CSV 文件")
    
    # 从 CSV 导入
    df_csv = pd.read_csv('employees.csv')
    print("\n从 CSV 导入的数据:")
    print(df_csv)
    
    # 导出为 Excel
    df.to_excel('employees.xlsx', index=False, sheet_name='Employees')
    print("\n数据已导出为 Excel 文件")
    
    # 从 Excel 导入
    df_excel = pd.read_excel('employees.xlsx', sheet_name='Employees')
    print("\n从 Excel 导入的数据:")
    print(df_excel)
    
    # 导出为 JSON
    df.to_json('employees.json', orient='records', indent=2)
    print("\n数据已导出为 JSON 文件")
    
    # 从 JSON 导入
    df_json = pd.read_json('employees.json')
    print("\n从 JSON 导入的数据:")
    print(df_json)

# 数据选择与过滤
def data_selection_filtering():
    """数据选择与过滤示例"""
    
    # 创建示例数据
    df = pd.DataFrame({
        'name': ['Alice', 'Bob', 'Charlie', 'David', 'Eve', 'Frank'],
        'age': [25, 30, 35, 28, 32, 45],
        'city': ['New York', 'London', 'Paris', 'Tokyo', 'Sydney', 'Berlin'],
        'salary': [50000, 60000, 70000, 55000, 65000, 80000],
        'department': ['IT', 'HR', 'Finance', 'IT', 'Marketing', 'IT']
    })
    
    print("原始数据:")
    print(df)
    
    # 列选择
    print("\n选择特定列:")
    print(df[['name', 'age', 'salary']])
    
    # 行选择
    print("\n选择前3行:")
    print(df.head(3))
    
    print("\n选择第2-4行:")
    print(df.iloc[1:4])
    
    # 条件过滤
    print("\n年龄大于30的员工:")
    print(df[df['age'] > 30])
    
    print("\nIT部门的员工:")
    print(df[df['department'] == 'IT'])
    
    print("\n年龄在25-35之间且薪资大于60000的员工:")
    filtered = df[(df['age'] >= 25) & (df['age'] <= 35) & (df['salary'] > 60000)]
    print(filtered)
    
    # 使用 query 方法
    print("\n使用 query 方法:")
    result = df.query('age > 30 and salary > 60000')
    print(result)
    
    # 多级索引
    df_indexed = df.set_index(['department', 'name'])
    print("\n多级索引:")
    print(df_indexed)
    
    print("\n选择 IT 部门的所有员工:")
    print(df_indexed.loc['IT'])

# 数据清洗
def data_cleaning():
    """数据清洗示例"""
    
    # 创建包含缺失值和重复值的数据
    data = {
        'name': ['Alice', 'Bob', 'Charlie', 'Alice', 'David', np.nan, 'Eve'],
        'age': [25, 30, np.nan, 25, 28, 32, 35],
        'city': ['New York', 'London', 'Paris', 'New York', 'Tokyo', 'Sydney', 'Sydney'],
        'salary': [50000, 60000, 70000, 50000, 55000, 65000, 65000]
    }
    df = pd.DataFrame(data)
    
    print("原始数据:")
    print(df)
    
    # 检查缺失值
    print("\n缺失值统计:")
    print(df.isnull().sum())
    
    # 处理缺失值
    print("\n删除包含缺失值的行:")
    df_dropped = df.dropna()
    print(df_dropped)
    
    print("\n用均值填充年龄缺失值:")
    df_filled = df.copy()
    df_filled['age'].fillna(df_filled['age'].mean(), inplace=True)
    print(df_filled)
    
    # 检查重复值
    print("\n重复值统计:")
    print(df.duplicated().sum())
    
    print("\n删除重复值:")
    df_no_duplicates = df.drop_duplicates()
    print(df_no_duplicates)
    
    # 数据类型转换
    print("\n原始数据类型:")
    print(df.dtypes)
    
    df['age'] = df['age'].astype('Int64')  # 可空整数类型
    df['salary'] = df['salary'].astype('float64')
    
    print("\n转换后数据类型:")
    print(df.dtypes)
    
    # 异常值检测
    print("\n检测薪资异常值 (使用 IQR 方法):")
    Q1 = df['salary'].quantile(0.25)
    Q3 = df['salary'].quantile(0.75)
    IQR = Q3 - Q1
    lower_bound = Q1 - 1.5 * IQR
    upper_bound = Q3 + 1.5 * IQR
    
    outliers = df[(df['salary'] < lower_bound) | (df['salary'] > upper_bound)]
    print(f"异常值: {outliers}")

# 数据变换
def data_transformation():
    """数据变换示例"""
    
    # 创建示例数据
    df = pd.DataFrame({
        'name': ['Alice', 'Bob', 'Charlie', 'David', 'Eve', 'Frank', 'Grace'],
        'department': ['IT', 'HR', 'Finance', 'IT', 'Marketing', 'IT', 'HR'],
        'salary': [50000, 60000, 70000, 55000, 65000, 80000, 58000],
        'hire_date': pd.date_range('2020-01-01', periods=7, freq='M'),
        'performance': [85, 92, 78, 88, 95, 82, 90]
    })
    
    print("原始数据:")
    print(df)
    
    # 数据排序
    print("\n按薪资降序排列:")
    df_sorted = df.sort_values('salary', ascending=False)
    print(df_sorted)
    
    print("\n按部门和薪资排序:")
    df_multi_sorted = df.sort_values(['department', 'salary'], ascending=[True, False])
    print(df_multi_sorted)
    
    # 分组聚合
    print("\n按部门分组统计:")
    dept_stats = df.groupby('department').agg({
        'salary': ['mean', 'sum', 'count'],
        'performance': 'mean'
    })
    print(dept_stats)
    
    print("\n各部门平均薪资:")
    avg_salary = df.groupby('department')['salary'].mean()
    print(avg_salary)
    
    # 数据合并
    # 创建第二个 DataFrame
    df2 = pd.DataFrame({
        'name': ['Alice', 'Bob', 'Charlie', 'David', 'Eve'],
        'bonus': [5000, 6000, 7000, 5500, 6500]
    })
    
    print("\n第二个 DataFrame:")
    print(df2)
    
    print("\n内连接合并:")
    merged_inner = pd.merge(df, df2, on='name', how='inner')
    print(merged_inner)
    
    # 数据透视表
    print("\n数据透视表:")
    pivot_table = df.pivot_table(
        values='salary',
        index='department',
        aggfunc=['mean', 'sum', 'count']
    )
    print(pivot_table)
    
    # 添加新列
    df['salary_grade'] = pd.cut(
        df['salary'], 
        bins=[0, 50000, 70000, 100000], 
        labels=['Low', 'Medium', 'High']
    )
    
    print("\n添加薪资等级列:")
    print(df[['name', 'salary', 'salary_grade']])
    
    # 应用函数
    df['performance_level'] = df['performance'].apply(
        lambda x: 'Excellent' if x >= 90 else 'Good' if x >= 80 else 'Average'
    )
    
    print("\n添加绩效等级列:")
    print(df[['name', 'performance', 'performance_level']])

# 时间序列数据处理
def time_series_analysis():
    """时间序列数据分析示例"""
    
    # 创建时间序列数据
    dates = pd.date_range('2023-01-01', periods=365, freq='D')
    np.random.seed(42)
    
    # 模拟销售数据
    sales_data = pd.DataFrame({
        'date': dates,
        'sales': np.random.normal(1000, 200, 365) + np.sin(np.arange(365) * 2 * np.pi / 7) * 100,
        'category': np.random.choice(['A', 'B', 'C'], 365)
    })
    
    print("时间序列数据:")
    print(sales_data.head(10))
    
    # 设置日期索引
    sales_data.set_index('date', inplace=True)
    
    # 重采样
    print("\n按月重采样:")
    monthly_sales = sales_data['sales'].resample('M').mean()
    print(monthly_sales)
    
    print("\n按周重采样:")
    weekly_sales = sales_data['sales'].resample('W').sum()
    print(weekly_sales.head())
    
    # 滚动窗口
    print("\n7天滚动平均:")
    rolling_mean = sales_data['sales'].rolling(window=7).mean()
    print(rolling_mean.head(10))
    
    # 时间序列绘图
    plt.figure(figsize=(12, 6))
    plt.plot(sales_data.index, sales_data['sales'], label='Daily Sales', alpha=0.7)
    plt.plot(rolling_mean.index, rolling_mean, label='7-Day Rolling Mean', linewidth=2)
    plt.title('Daily Sales with Rolling Mean')
    plt.xlabel('Date')
    plt.ylabel('Sales')
    plt.legend()
    plt.grid(True)
    plt.xticks(rotation=45)
    plt.tight_layout()
    plt.show()

# 数据可视化
def data_visualization():
    """数据可视化示例"""
    
    # 创建示例数据
    df = pd.DataFrame({
        'category': ['A', 'B', 'C', 'D', 'E'],
        'values': [23, 45, 56, 78, 32],
        'values2': [12, 34, 45, 67, 23]
    })
    
    # 设置绘图风格
    plt.style.use('seaborn-v0_8')
    
    # 柱状图
    plt.figure(figsize=(10, 6))
    plt.subplot(2, 2, 1)
    plt.bar(df['category'], df['values'])
    plt.title('Bar Chart')
    plt.xlabel('Category')
    plt.ylabel('Values')
    
    # 散点图
    plt.subplot(2, 2, 2)
    plt.scatter(df['values'], df['values2'], s=100, alpha=0.7)
    plt.title('Scatter Plot')
    plt.xlabel('Values')
    plt.ylabel('Values2')
    
    # 饼图
    plt.subplot(2, 2, 3)
    plt.pie(df['values'], labels=df['category'], autopct='%1.1f%%')
    plt.title('Pie Chart')
    
    # 箱线图
    plt.subplot(2, 2, 4)
    plt.boxplot([df['values'], df['values2']], labels=['Values', 'Values2'])
    plt.title('Box Plot')
    
    plt.tight_layout()
    plt.show()
    
    # 使用 Seaborn 创建更复杂的图表
    # 创建更复杂的数据集
    np.random.seed(42)
    complex_data = pd.DataFrame({
        'x': np.random.normal(0, 1, 200),
        'y': np.random.normal(0, 1, 200),
        'category': np.random.choice(['A', 'B', 'C'], 200)
    })
    
    # 热力图
    plt.figure(figsize=(12, 8))
    
    plt.subplot(2, 2, 1)
    correlation_matrix = df[['values', 'values2']].corr()
    sns.heatmap(correlation_matrix, annot=True, cmap='coolwarm', center=0)
    plt.title('Correlation Heatmap')
    
    # 分类散点图
    plt.subplot(2, 2, 2)
    sns.scatterplot(data=complex_data, x='x', y='y', hue='category')
    plt.title('Categorical Scatter Plot')
    
    # 箱线图
    plt.subplot(2, 2, 3)
    sns.boxplot(data=complex_data, x='category', y='x')
    plt.title('Box Plot by Category')
    
    # 小提琴图
    plt.subplot(2, 2, 4)
    sns.violinplot(data=complex_data, x='category', y='y')
    plt.title('Violin Plot by Category')
    
    plt.tight_layout()
    plt.show()

# 实际应用示例
def real_world_example():
    """实际应用示例：销售数据分析"""
    
    # 创建模拟销售数据
    np.random.seed(42)
    dates = pd.date_range('2023-01-01', periods=100, freq='D')
    
    sales_data = pd.DataFrame({
        'date': dates,
        'product': np.random.choice(['Laptop', 'Phone', 'Tablet', 'Watch'], 100),
        'region': np.random.choice(['North', 'South', 'East', 'West'], 100),
        'sales': np.random.randint(10, 100, 100),
        'revenue': np.random.randint(1000, 10000, 100)
    })
    
    print("销售数据:")
    print(sales_data.head())
    
    # 基本统计
    print("\n基本统计信息:")
    print(sales_data.describe())
    
    # 按产品分析
    print("\n按产品统计:")
    product_stats = sales_data.groupby('product').agg({
        'sales': 'sum',
        'revenue': 'sum'
    }).sort_values('revenue', ascending=False)
    print(product_stats)
    
    # 按地区分析
    print("\n按地区统计:")
    region_stats = sales_data.groupby('region').agg({
        'sales': 'sum',
        'revenue': 'sum'
    }).sort_values('revenue', ascending=False)
    print(region_stats)
    
    # 时间趋势分析
    sales_data['date'] = pd.to_datetime(sales_data['date'])
    daily_revenue = sales_data.groupby('date')['revenue'].sum()
    
    # 7天滚动平均
    rolling_revenue = daily_revenue.rolling(window=7).mean()
    
    # 可视化
    plt.figure(figsize=(15, 10))
    
    # 每日收入趋势
    plt.subplot(2, 2, 1)
    plt.plot(daily_revenue.index, daily_revenue, label='Daily Revenue', alpha=0.7)
    plt.plot(rolling_revenue.index, rolling_revenue, label='7-Day Rolling Average', linewidth=2)
    plt.title('Daily Revenue Trend')
    plt.xlabel('Date')
    plt.ylabel('Revenue')
    plt.legend()
    plt.xticks(rotation=45)
    
    # 产品收入分布
    plt.subplot(2, 2, 2)
    product_revenue = sales_data.groupby('product')['revenue'].sum()
    plt.pie(product_revenue.values, labels=product_revenue.index, autopct='%1.1f%%')
    plt.title('Revenue by Product')
    
    # 地区收入对比
    plt.subplot(2, 2, 3)
    region_revenue = sales_data.groupby('region')['revenue'].sum()
    plt.bar(region_revenue.index, region_revenue.values)
    plt.title('Revenue by Region')
    plt.xlabel('Region')
    plt.ylabel('Revenue')
    
    # 产品-地区热力图
    plt.subplot(2, 2, 4)
    pivot_data = sales_data.pivot_table(
        values='revenue', 
        index='product', 
        columns='region', 
        aggfunc='sum'
    )
    sns.heatmap(pivot_data, annot=True, fmt='.0f', cmap='YlOrRd')
    plt.title('Revenue Heatmap: Product vs Region')
    
    plt.tight_layout()
    plt.show()

# 主函数
def main():
    """主函数，运行所有示例"""
    print("=== Pandas 基础操作 ===")
    pandas_basics()
    
    print("\n=== 数据导入导出 ===")
    data_import_export()
    
    print("\n=== 数据选择与过滤 ===")
    data_selection_filtering()
    
    print("\n=== 数据清洗 ===")
    data_cleaning()
    
    print("\n=== 数据变换 ===")
    data_transformation()
    
    print("\n=== 时间序列分析 ===")
    time_series_analysis()
    
    print("\n=== 数据可视化 ===")
    data_visualization()
    
    print("\n=== 实际应用示例 ===")
    real_world_example()

if __name__ == "__main__":
    main()
```

## 扩展资源

- [Pandas 官方文档](https://pandas.pydata.org/docs/)
- [Pandas 用户指南](https://pandas.pydata.org/docs/user_guide/)
- [Pandas API 参考](https://pandas.pydata.org/docs/reference/)
- [10 Minutes to Pandas](https://pandas.pydata.org/docs/user_guide/10min.html)
- [Pandas Cookbook](https://pandas.pydata.org/docs/user_guide/cookbook.html)
- [Matplotlib 文档](https://matplotlib.org/stable/contents.html)
- [Seaborn 文档](https://seaborn.pydata.org/)