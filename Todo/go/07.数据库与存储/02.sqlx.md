
# AI Prompt: `sqlx` - Go `database/sql` 的最佳搭档

## 核心目标

你是一位追求代码简洁与开发效率的 Go 语言专家。请撰写一篇关于 `sqlx` 库的深度实战指南。本文旨在向已经熟悉 `database/sql` 的开发者展示，`sqlx` 如何在不牺牲性能和控制力的前提下，显著提升数据库操作的便利性和代码的可读性。

## 内容结构

### 1. 引言：寻找 `database/sql` 与 ORM 之间的“甜蜜点”
- **`database/sql` 的困境**：简要回顾 `database/sql` 的优点（标准化、稳定）和痛点（样板代码繁多，如手动 `Scan` 多个字段）。
- **`sqlx` 的定位**：将 `sqlx` 定位为 `database/sql` 的一个轻量级、无缝增强的超集。它不试图隐藏 SQL，也不提供复杂的 ORM 功能，而是专注于提升日常数据库操作的编码效率。
- **核心理念**：`sqlx` 遵循 `database/sql` 的设计哲学，但提供了“恰到好处”的便利工具。

### 2. 核心功能详解与实战

- **安装与基本设置**
  - 展示如何 `go get` `sqlx`。
  - 演示如何用 `sqlx.NewDb` 或 `sqlx.Open` 来包装一个标准的 `*sql.DB` 对象，强调其与 `database/sql` 的无缝集成。

- **`StructScan`：告别手动扫描**
  - **核心痛点解决**：通过一个 “before/after” 对比，展示一个从 `database/sql` 的 `rows.Scan(&user.ID, &user.Name, ...)` 到 `sqlx` 的 `rows.StructScan(&user)` 的重构过程，直观体现代码量的减少。
  - **`db` 标签**：解释如何使用 `db` struct tag 来映射数据库列名和结构体字段名，特别是当两者命名不一致时。

- **`Get` 和 `Select`：查询操作的快捷方式**
  - **`Get`**：演示如何使用 `db.Get()` 将单行查询结果直接扫描到一个结构体中。与 `db.QueryRow().Scan()` 对比，突出其简洁性。
  - **`Select`**：演示如何使用 `db.Select()` 将多行查询结果直接扫描到一个结构体切片中。与 `for rows.Next() { ... }` 循环对比，展示其代码的紧凑性。

- **命名参数：让 SQL 更具可读性**
  - **`?` 的问题**：指出当查询参数增多时，使用 `?` 作为占位符容易导致顺序混乱和维护困难。
  - **`NamedQuery` 和 `NamedExec`**：详细介绍如何使用 `sqlx.Named()` 或直接传递 `struct` 或 `map`，配合 SQL 中的 `:field_name` 语法，实现参数的按名绑定。
  - **代码示例**：提供一个复杂的 `UPDATE` 语句，展示命名参数如何让代码意图一目了然。

- **`sqlx.In`：优雅地处理 `IN` 查询**
  - **`IN (?)` 的经典难题**：解释为什么动态构建 `IN` 查询（例如 `WHERE id IN (?, ?, ?)`）在 `database/sql` 中很棘手。
  - **`sqlx.In` 的解决方案**：演示如何使用 `sqlx.In()` 配合一个切片来生成正确的查询字符串和参数列表，并用 `db.Rebind()` 来适配不同数据库的占位符语法。

### 3. 在事务中使用 `sqlx`
- **`sqlx.Tx`**：解释 `sqlx` 提供了 `sqlx.Tx` 类型，它包装了 `sql.Tx` 并提供了 `sqlx.DB` 上的所有便利方法（`Get`, `Select`, `NamedExec` 等）。
- **代码示例**：展示一个使用 `db.Beginx()` 开启事务，并在事务中执行多次 `NamedExec` 和 `Get` 操作的完整流程，包括 `Commit` 和 `Rollback`。

### 4. `sqlx` 最佳实践
- **何时使用 `sqlx`**：几乎所有使用 `database/sql` 的项目都可以从 `sqlx` 中受益，特别是当需要将数据库行映射到 Go 结构体时。
- **与 `database/sql` 混用**：强调开发者可以根据需要在 `sqlx` 和原生 `database/sql` API 之间自由切换，没有任何限制。
- **不要过度设计**：提醒 `sqlx` 是一个工具，而不是一个框架。避免在其之上构建复杂的抽象层，以免失去其简洁的优势。

### 5. 完整示例：重构 CRUD 应用
- 基于 `01.database_sql.md` 中的 CRUD 示例，提供一个完整的重构版本。
- 使用 `sqlx` 的 `Get`, `Select`, `NamedExec` 和 `StructScan` 来重写所有的增删改查函数。
- 通过代码对比，让读者清晰地看到 `sqlx` 带来的代码简洁性和可维护性的提升。

## 代码要求
- 所有代码片段必须是完整、可运行的。
- 遵循 Go 的编码规范和最佳实践。
- 注释清晰，特别是在展示 `sqlx` 替代 `database/sql` 的部分。
- 在示例代码的开头，用注释说明所需的数据库表结构 (SQL DDL)。

## 文章风格
- **实用主义**：聚焦于解决实际问题，提供可以直接复制粘贴并运行的代码。
- **对比鲜明**：通过与 `database/sql` 的直接比较，突出 `sqlx` 的核心价值。
- **清晰简洁**：语言直白，避免不必要的理论铺垫。
