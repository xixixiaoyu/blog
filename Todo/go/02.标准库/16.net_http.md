# `net/http`：构建强大的 Go Web 服务

请你扮演一位 Go 语言的 Web 架构师和后端开发专家，为一篇名为《`net/http`：构建强大的 Go Web 服务》的教程生成内容。

**文章目标：** 帮助 Go 开发者全面掌握 `net/http` 标准库，不仅能用它来编写简单的 HTTP 客户端和服务器，更能深入理解其设计模式，学会构建结构清晰、可扩展、生产级的 Web 应用，包括路由、中间件和优雅关闭等高级主题。

**核心概念：**

1.  **HTTP 客户端 (`http.Client`)**
    *   **`http.Get`：** 介绍最简单的发送 GET 请求的方式，并解释其背后使用的是一个共享的、默认的 `http.DefaultClient`。
    *   **`http.NewRequest`：** 演示如何创建更复杂的请求，如 POST、PUT 等，并设置请求头（Headers）、请求体（Body）和查询参数（Query Parameters）。
    *   **`http.Client` 的重要性：**
        *   解释为什么在生产环境中**必须**自定义 `http.Client`。
        *   **核心配置：** 重点讲解 `Transport` 字段，特别是 `MaxIdleConns`, `IdleConnTimeout`, `TLSClientConfig` 等参数的配置，以实现连接池复用和性能优化。
        *   **超时控制：** 强调为 `Client` 设置 `Timeout` 的重要性，以防止请求无限期阻塞。
    *   提供一个创建和配置自定义 `http.Client` 的最佳实践示例。

2.  **HTTP 服务端 (`http.Server`)**
    *   **`http.ListenAndServe(addr, handler)`：**
        *   介绍启动一个 HTTP 服务器的最简单方法。
        *   解释 `addr` 参数（如 `:8080`）和 `handler` 参数（`nil` 表示使用默认的 `http.DefaultServeMux`）。
    *   **`http.Handler` 和 `http.HandlerFunc`：**
        *   **`http.Handler` 接口：** 讲解 `ServeHTTP(ResponseWriter, *Request)` 方法是 Go Web 开发的核心，所有处理器都必须实现它。
        *   **`http.HandlerFunc` 类型：** 介绍这个适配器类型，它允许一个普通的函数（签名匹配 `ServeHTTP`）被当作 `http.Handler` 使用。
    *   **`http.ServeMux`：请求路由器**
        *   介绍 `http.NewServeMux()` 创建一个新的路由器。
        *   `mux.Handle(pattern, handler)` 和 `mux.HandleFunc(pattern, handlerFunc)`：演示如何注册路由和对应的处理器。
        *   讲解 `DefaultServeMux` 的工作方式和潜在的安全性问题（容易被第三方包无意中注册路由）。

3.  **构建生产级服务：`http.Server` 结构体**
    *   **为什么要自定义 `http.Server`？** 为了更精细地控制服务器行为，如超时和优雅关闭。
    *   **核心配置：**
        *   `Addr`: 服务器监听地址。
        *   `Handler`: 根处理器（通常是一个路由器）。
        *   `ReadTimeout`, `WriteTimeout`, `IdleTimeout`：详细解释这三个超时设置的含义和重要性，它们是防止慢客户端攻击和资源耗尽的关键。
    *   **优雅关闭 (Graceful Shutdown)：**
        *   提供一个完整的优雅关闭示例：监听 `os.Interrupt` 和 `syscall.SIGTERM` 信号，然后调用 `server.Shutdown(ctx)`。
        *   解释 `Shutdown` 如何平滑地关闭服务器：停止接受新连接，等待现有请求处理完成，最后关闭服务器。

4.  **中间件 (Middleware)：增强你的 Handler**
    *   **设计模式：** 解释 Go 中间件的核心思想——一个函数接收一个 `http.Handler`，并返回一个新的 `http.Handler`。这个新的 `Handler` 在调用原始 `Handler` 的前后执行额外的逻辑。
    *   **`func(http.Handler) http.Handler`：**
        *   提供一个清晰的 `loggingMiddleware` 示例，用于记录每个请求的方法、URL 和处理时间。
        *   提供一个 `authMiddleware` 示例，用于在处理请求前检查认证信息。
    *   **链式调用：** 演示如何将多个中间件串联起来，形成一个处理链。

5.  **处理请求与响应**
    *   **解析请求 (`*http.Request`)：**
        *   解析 URL 查询参数：`r.URL.Query()`。
        *   解析 POST 表单：`r.ParseForm()` 和 `r.PostForm`。
        *   解析 JSON 请求体：使用 `json.NewDecoder(r.Body).Decode()`。
    *   **写入响应 (`http.ResponseWriter`)：**
        *   设置响应头：`w.Header().Set("Content-Type", "application/json")`。
        *   设置状态码：`w.WriteHeader(http.StatusOK)`。
        *   写入响应体：`w.Write([]byte("..."))` 或 `json.NewEncoder(w).Encode(data)`。

**代码示例要求：**
*   提供一个包含自定义 `http.Client` 和 `http.Server` 的完整、可运行的客户端/服务端程序。
*   服务器代码必须包含优雅关闭逻辑。
*   中间件的示例要清晰地展示其“包装”和“链式调用”的模式。
*   代码注释要解释每个重要配置项（如超时）的意义。

**总结：**
回顾 `net/http` 包如何通过其简洁而强大的接口（`Handler`）、可组合的中间件模式以及对底层细节的精细控制（`Client` 和 `Server` 配置），成为构建从简单微服务到复杂 Web 应用的坚实基础。鼓励开发者在生产项目中始终遵循最佳实践。
