# AI Prompt: 在 Go 中构建健壮的 WebSocket 服务

请你扮演一位精通实时通信技术的 Go 工程师，撰写一篇关于如何使用 Go 构建生产级 WebSocket 服务的技术教程。

**文章目标：**
本文旨在帮助读者深入理解 WebSocket 的工作原理，并掌握在 Go 中从零开始构建一个功能完备、稳定可靠的 WebSocket 服务的核心技术。重点将放在连接管理、心跳机制和并发安全上。

**核心内容：**

1.  **开篇：WebSocket 与实时 Web**
    *   简述 WebSocket 协议相比于传统 HTTP 轮询的优势（全双工、低延迟、更少的头部开销）。
    *   描绘其在实时聊天、在线游戏、金融看板、协同编辑等场景中的应用价值。
    *   介绍 Go 实现 WebSocket 的常用库，并选择一个主流库（如 `gorilla/websocket`）作为本文的实践基础。

2.  **第一步：HTTP 升级与连接建立**
    *   解释 WebSocket 的握手过程：它如何通过一个标准的 HTTP/1.1 请求升级到 WebSocket 协议。
    *   **核心组件 `Upgrader`**：介绍 `gorilla/websocket.Upgrader` 的作用，特别是 `CheckOrigin`、`ReadBufferSize` 和 `WriteBufferSize` 字段的配置。
    *   **代码示例**：创建一个 HTTP 端点，使用 `upgrader.Upgrade()` 方法将 HTTP 连接升级为 WebSocket 长连接，并处理升级失败的情况。

3.  **核心：连接管理与数据收发**
    *   **封装连接对象**：设计一个 `Client` 或 `Connection` 结构体，用于封装 WebSocket 连接（`*websocket.Conn`）以及其他用户相关的信息（如用户 ID、所属房间等）。
    *   **并发读写**：
        *   强调 `gorilla/websocket` 的并发安全策略：一个连接同时只能有一个读取者和一个写入者。
        *   **代码示例**：为每个连接启动两个 Goroutine：一个 `readPump()` 用于持续读取客户端消息，一个 `writePump()` 用于将待发送消息写入连接。
        *   解释这种“读写分离”模式如何避免并发冲突。
    *   **中央管理器 `Hub`**：
        *   设计一个 `Hub` 结构体，用于集中管理所有客户端连接。`Hub` 应包含注册（`register`）、注销（`unregister`）和广播（`broadcast`）等 channel，用于安全地操作客户端列表。
        *   **代码示例**：实现 `Hub` 的 `run()` 方法，通过 `select` 语句处理来自各个 channel 的事件，实现客户端的上线、下线和消息广播。

4.  **保证连接的活性：心跳机制**
    *   解释为什么需要心跳：防止因网络中间设备（如 NAT、防火墙）超时而断开连接。
    *   **实现方式**：
        *   在 `readPump()` 中，通过 `conn.SetReadDeadline()` 设置一个读取超时。
        *   客户端定期发送 Ping 消息，服务端在收到 Ping 后，由 `gorilla/websocket` 库自动回复 Pong。
        *   如果超过时限没有收到任何消息（包括 Ping），`conn.ReadMessage()` 会返回一个错误，从而可以安全地关闭连接。
        *   **代码示例**：在 `readPump()` 中加入 `SetReadDeadline` 和相应的错误处理逻辑。

5.  **优雅关闭**
    *   演示如何在 `readPump` 或 `writePump` 发生错误时，确保连接被正确关闭，并通知 `Hub` 将其移除。
    *   讨论如何处理 `websocket.CloseNormalClosure` 和 `websocket.CloseGoingAway` 等关闭状态。

**代码要求：**
*   提供一个完整的、模块化的项目结构，包括 `main.go`、`hub.go` 和 `client.go`。
*   所有代码必须是并发安全的，并有详细的注释来解释 channel 和 Goroutine 的交互逻辑。
*   关键部分（如 `readPump`、`writePump` 和 `Hub.run`）需要有流程图或文字描述来辅助理解。

**总结：**
回顾构建健壮 WebSocket 服务的关键点：清晰的连接管理、并发安全的读写分离、以及可靠的心跳机制。鼓励读者基于此模型进行扩展，例如实现消息的持久化、多房间聊天等更复杂的功能。
