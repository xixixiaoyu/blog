# 单元测试

---

请你扮演一位经验丰富的 Go 开发者和测试倡导者，为 Go 初学者撰写一篇关于“单元测试”的入门实战指南。这篇文章应该清晰、实用，充满了最佳实践。

**文章目标：**

本文旨在教会读者如何使用 Go 的内置 `testing` 包来编写清晰、有效、可维护的单元测试。读者在阅读后，应该能够掌握单元测试的基本流程、核心 API，并学会使用子测试和辅助函数来组织更复杂的测试用例。

**核心内容与结构：**

1.  **开篇：单元测试的“第一性原理”**
    *   从一个简单的问题开始：你如何确定你写的函数是正确的？
    *   引出单元测试的定义：它是验证软件中最小功能单元（一个函数或方法）是否按预期工作的过程。
    *   强调其价值：快速反馈、保证代码质量、放心地进行重构。

2.  **Go 测试的约定与基础**
    *   **文件命名：** 测试代码必须位于 `_test.go` 结尾的文件中。
    *   **函数签名：** 测试函数必须以 `Test` 开头，并接收一个 `*testing.T` 类型的参数，例如 `func TestMyFunction(t *testing.T) {}`。
    *   **运行测试：** 介绍 `go test` 命令，以及它如何自动发现并执行这些测试函数。

3.  **核心武器：`*testing.T`**
    *   将 `t` 对象比作测试过程中的“裁判和记录员”。
    *   **报告失败：**
        *   `t.Logf(format, args...)`: 记录信息，但测试继续。用于输出调试信息。
        *   `t.Errorf(format, args...)`: 报告一个错误，但测试继续。这是最常用的失败报告方式。
        *   `t.Fatalf(format, args...)`: 报告一个致命错误，并立即停止当前测试函数的执行。
    *   **清理工作：**
        *   `t.Cleanup(f func())`: 注册一个清理函数，在测试函数结束时执行（无论是成功还是失败）。非常适合用于关闭文件、数据库连接等资源清理工作。

4.  **进阶技巧：组织更复杂的测试**
    *   **子测试 (Subtests)：`t.Run()`**
        *   **为什么需要？** 当一个函数需要测试多种场景时，如果把所有场景都写在一个测试函数里，一旦某个场景失败，整个测试函数都会失败，难以定位问题。子测试可以解决这个问题。
        *   **怎么做？** 演示如何使用 `t.Run("测试场景名", func(t *testing.T) { ... })` 来创建独立的测试单元。
        *   **核心优势：**
            *   **独立报告：** 每个子测试都有独立的成功/失败状态。
            *   **共享设置/清理：** 可以在 `t.Run` 外部进行统一的设置，在 `t.Run` 内部进行场景特有的设置。
            *   **选择性运行：** 可以使用 `go test -run TestMyFunction/subtest_name` 来只运行特定的子测试。
    *   **测试辅助函数 (Test Helpers)：`t.Helper()`**
        *   **为什么需要？** 当多个测试函数中有重复的逻辑（如创建一个模拟对象、检查一个通用错误）时，我们会将这些逻辑提取到一个辅助函数中。
        *   **问题：** 如果辅助函数中发生了测试失败（如调用了 `t.Errorf`），错误报告的行号会指向辅助函数内部，而不是调用它的地方，这不利于快速定位问题。
        *   **怎么做？** 在辅助函数的第一行调用 `t.Helper()`。这会告诉测试框架，这是一个辅助函数，如果其中发生失败，请报告调用它的那一行。

**代码要求：**

*   提供一个简单的被测试函数，例如 `func Add(a, b int) int`。
*   围绕这个函数，提供一个完整的 `_test.go` 文件示例。
*   示例中必须清晰地展示 `t.Errorf` 的用法。
*   示例中必须使用 `t.Run` 来组织多个测试用例（例如，正数相加、负数相加、加零等）。
*   示例中必须包含一个使用了 `t.Helper()` 的辅助函数，例如 `assertCorrectMessage(t *testing.T, got, want string)`。

**总结：**

重申单元测试是保证代码质量的基石。鼓励读者养成“编码-测试-重构”的节奏，并善用子测试和辅助函数来编写清晰、可维护的测试代码。一个拥有良好单元测试的项目，是开发者信心的最大保障。
